<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 837e6360-30ee-40f6-b5f0-a7750dc68614 (2025-12-08 02:58Z) -->

# 勤怠テーブル画面のバックエンド実装 (2025-12-08 02:58Z)

_**User (2025-12-07 14:19Z)**_

では

@docs/detailed-design/ui/attendance-table-screen.md のバックエンドの実装をしてください。

@feture_list/TeamSpirit機能一覧.md と

@frontend/src/views/TimesheetScreen.vue と

@docs/entities/mysql_table_design.sql を参考にしてください。

---

_**Agent (model claude-4.5-sonnet, mode Agent)**_

勤務表画面のバックエンド実装を行います。仕様書とフロントエンドの実装を参考に、必要なAPIエンドポイントを実装します。

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: backend/routes/attendance.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: backend/server.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: backend/config/database.js</summary>

</details>
</tool-use>

---

勤務表画面のバックエンドAPIを実装します。attendance.jsに必要なエンドポイントを追加します。

---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: backend/routes/attendance.js</summary>

**Chunk 1**
Lines added: 912, lines removed: undefined

```diff
@@ -415,4 +415,916 @@
    }
  });
+ 
+ /**
+  * 月間勤務表取得API
+  * GET /api/attendance/monthly
+  */
+ router.get('/monthly', async (req, res) =&gt; {
+   const { employeeId, year, month } = req.query;
+ 
+   if (!employeeId || !year || !month) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員ID、年、月が必要です。'
+     });
+   }
+ 
+   try {
+     // 月の開始日と終了日を計算
+     const startDate = &#96;${year}-${String(month).padStart(2, '0')}-01&#96;;
+     const endDate = new Date(year, month, 0).toISOString().split('T')[0];
+ 
+     // 月間勤務データを取得
+     const [attendanceRows] = await db.execute(
+       &#96;SELECT 
+         ar.ATTENDANCE_ID,
+         ar.EMPLOYEE_ID,
+         ar.WORK_DATE,
+         ar.CLOCK_IN_TIME,
+         ar.CLOCK_OUT_TIME,
+         ar.CLOCK_IN_TYPE,
+         ar.CLOCK_OUT_TYPE,
+         ar.WORK_LOCATION_CODE,
+         ar.ACTUAL_WORK_HOURS,
+         ar.SCHEDULED_WORK_HOURS,
+         ar.OVERTIME_HOURS,
+         ar.NIGHT_WORK_HOURS,
+         ar.HOLIDAY_WORK_HOURS,
+         ar.IS_DAILY_CONFIRMED,
+         ar.DAILY_CONFIRMED_AT,
+         ar.APPROVAL_STATUS,
+         ar.REMARK_TEXT
+        FROM ATTENDANCE_RECORD ar
+        WHERE ar.EMPLOYEE_ID = ? AND ar.WORK_DATE BETWEEN ? AND ?
+        ORDER BY ar.WORK_DATE&#96;,
+       [employeeId, startDate, endDate]
+     );
+ 
+     // 各勤怠記録に対して休憩時間、公用外出、工数実績を取得
+     const dailyData = [];
+     for (const attendance of attendanceRows) {
+       // 休憩時間を取得
+       const [breakRows] = await db.execute(
+         &#96;SELECT BREAK_ID, BREAK_SEQ, BREAK_START_TIME, BREAK_END_TIME, BREAK_DURATION_MINUTES, BREAK_TYPE
+          FROM BREAK_TIME
+          WHERE ATTENDANCE_ID = ?
+          ORDER BY BREAK_SEQ&#96;,
+         [attendance.ATTENDANCE_ID]
+       );
+ 
+       // 公用外出を取得
+       const [outingRows] = await db.execute(
+         &#96;SELECT OUTING_ID, OUTING_SEQ, OUTING_START_TIME, OUTING_END_TIME, OUTING_DURATION_MINUTES, OUTING_PURPOSE
+          FROM OFFICIAL_OUTING
+          WHERE ATTENDANCE_ID = ?
+          ORDER BY OUTING_SEQ&#96;,
+         [attendance.ATTENDANCE_ID]
+       );
+ 
+       // 工数実績を取得
+       const [workHoursRows] = await db.execute(
+         &#96;SELECT WORK_HOURS_ID, JOB_CODE, WORK_CODE, WORK_HOURS_VALUE, WORK_VOLUME, INPUT_TYPE
+          FROM WORK_HOURS
+          WHERE ATTENDANCE_ID = ?&#96;,
+         [attendance.ATTENDANCE_ID]
+       );
+ 
+       dailyData.push({
+         ...attendance,
+         breakTimes: breakRows,
+         officialOutings: outingRows,
+         workHours: workHoursRows
+       });
+     }
+ 
+     // 月次サマリーデータを計算
+     const currentDate = new Date();
+     const isCurrentMonth = parseInt(year) === currentDate.getFullYear() &amp;&amp; parseInt(month) === currentDate.getMonth() + 1;
+     const cutoffDate = isCurrentMonth ? currentDate.toISOString().split('T')[0] : endDate;
+ 
+     // 所定出勤日数を計算（月の平日数）
+     const daysInMonth = new Date(year, month, 0).getDate();
+     let scheduledWorkDays = 0;
+     for (let day = 1; day &lt;= daysInMonth; day++) {
+       const date = new Date(year, month - 1, day);
+       const dayOfWeek = date.getDay();
+       if (dayOfWeek !== 0 &amp;&amp; dayOfWeek !== 6) { // 日曜日と土曜日を除く
+         scheduledWorkDays++;
+       }
+     }
+ 
+     // 実出勤日数（出勤時刻と退勤時刻が両方記録されている日数）
+     const actualWorkDays = attendanceRows.filter(row =&gt; 
+       row.CLOCK_IN_TIME &amp;&amp; row.CLOCK_OUT_TIME &amp;&amp; row.WORK_DATE &lt;= cutoffDate
+     ).length;
+ 
+     // 所定労働時間（7.5時間/日 × 所定出勤日数）
+     const scheduledWorkHours = scheduledWorkDays * 7.5;
+ 
+     // 総労働時間
+     const totalWorkHours = attendanceRows
+       .filter(row =&gt; row.WORK_DATE &lt;= cutoffDate)
+       .reduce((sum, row) =&gt; sum + (parseFloat(row.ACTUAL_WORK_HOURS) || 0), 0);
+ 
+     // 過不足時間（現在日までの）
+     const overUnderTime = totalWorkHours - (scheduledWorkHours / daysInMonth * new Date(cutoffDate).getDate());
+ 
+     // 法定休日労働
+     const legalHolidayWork = attendanceRows
+       .filter(row =&gt; row.WORK_DATE &lt;= cutoffDate)
+       .reduce((sum, row) =&gt; sum + (parseFloat(row.HOLIDAY_WORK_HOURS) || 0), 0);
+ 
+     // 法定時間内残業・法定時間外残業を計算
+     let withinLegalOvertime = 0;
+     let overLegalOvertime = 0;
+     for (const row of attendanceRows) {
+       if (row.WORK_DATE &lt;= cutoffDate) {
+         const actualHours = parseFloat(row.ACTUAL_WORK_HOURS) || 0;
+         if (actualHours &gt; 7.5 &amp;&amp; actualHours &lt;= 8) {
+           withinLegalOvertime += actualHours - 7.5;
+         } else if (actualHours &gt; 8) {
+           withinLegalOvertime += 0.5;
+           overLegalOvertime += actualHours - 8;
+         }
+       }
+     }
+ 
+     // 時間をHHH:MM形式に変換する関数
+     const formatHours = (hours) =&gt; {
+       const h = Math.floor(hours);
+       const m = Math.round((hours - h) * 60);
+       return &#96;${h}:${String(m).padStart(2, '0')}&#96;;
+     };
+ 
+     // 過不足時間を+/-H:MM形式に変換
+     const formatOverUnder = (hours) =&gt; {
+       const sign = hours &gt;= 0 ? '+' : '';
+       return &#96;${sign}${formatHours(Math.abs(hours))}&#96;;
+     };
+ 
+     const monthlySummary = {
+       scheduledWorkDays,
+       actualWorkDays,
+       scheduledWorkHours: formatHours(scheduledWorkHours),
+       totalWorkHours: formatHours(totalWorkHours),
+       overUnderTime: formatOverUnder(overUnderTime),
+       legalHolidayWork: formatHours(legalHolidayWork),
+       withinLegalOvertime: formatHours(withinLegalOvertime),
+       overLegalOvertime: formatHours(overLegalOvertime),
+       cutoffDate: cutoffDate.split('-').slice(1).join('/')
+     };
+ 
+     // 休暇申請データを取得
+     const [vacationRows] = await db.execute(
+       &#96;SELECT VACATION_ID, VACATION_TYPE_CODE, START_DATE, END_DATE, VACATION_DAYS, APPROVAL_STATUS
+        FROM VACATION_HISTORY
+        WHERE EMPLOYEE_ID = ? AND START_DATE BETWEEN ? AND ? AND APPROVAL_STATUS IN ('PENDING', 'APPROVED')
+        ORDER BY START_DATE&#96;,
+       [employeeId, startDate, endDate]
+     );
+ 
+     res.json({
+       success: true,
+       dailyData,
+       monthlySummary,
+       vacations: vacationRows
+     });
+   } catch (error) {
+     console.error('月間勤務表取得エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '月間勤務表の取得に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 日次勤怠記録取得API
+  * GET /api/attendance/daily
+  */
+ router.get('/daily', async (req, res) =&gt; {
+   const { employeeId, workDate } = req.query;
+ 
+   if (!employeeId || !workDate) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDと勤務日が必要です。'
+     });
+   }
+ 
+   try {
+     // 勤怠記録を取得
+     const [attendanceRows] = await db.execute(
+       &#96;SELECT 
+         ATTENDANCE_ID,
+         EMPLOYEE_ID,
+         WORK_DATE,
+         CLOCK_IN_TIME,
+         CLOCK_OUT_TIME,
+         CLOCK_IN_TYPE,
+         CLOCK_OUT_TYPE,
+         WORK_LOCATION_CODE,
+         ACTUAL_WORK_HOURS,
+         SCHEDULED_WORK_HOURS,
+         APPROVAL_STATUS,
+         REMARK_TEXT
+        FROM ATTENDANCE_RECORD
+        WHERE EMPLOYEE_ID = ? AND WORK_DATE = ?&#96;,
+       [employeeId, workDate]
+     );
+ 
+     if (attendanceRows.length === 0) {
+       return res.json({
+         success: true,
+         attendance: null
+       });
+     }
+ 
+     const attendance = attendanceRows[0];
+ 
+     // 休憩時間を取得
+     const [breakRows] = await db.execute(
+       &#96;SELECT BREAK_ID, BREAK_SEQ, BREAK_START_TIME, BREAK_END_TIME, BREAK_DURATION_MINUTES, BREAK_TYPE
+        FROM BREAK_TIME
+        WHERE ATTENDANCE_ID = ?
+        ORDER BY BREAK_SEQ&#96;,
+       [attendance.ATTENDANCE_ID]
+     );
+ 
+     // 公用外出を取得
+     const [outingRows] = await db.execute(
+       &#96;SELECT OUTING_ID, OUTING_SEQ, OUTING_START_TIME, OUTING_END_TIME, OUTING_DURATION_MINUTES, OUTING_PURPOSE
+        FROM OFFICIAL_OUTING
+        WHERE ATTENDANCE_ID = ?
+        ORDER BY OUTING_SEQ&#96;,
+       [attendance.ATTENDANCE_ID]
+     );
+ 
+     res.json({
+       success: true,
+       attendance: {
+         ...attendance,
+         breakTimes: breakRows,
+         officialOutings: outingRows
+       }
+     });
+   } catch (error) {
+     console.error('日次勤怠記録取得エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '日次勤怠記録の取得に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 勤怠記録更新API
+  * PUT /api/attendance/record
+  */
+ router.put('/record', async (req, res) =&gt; {
+   const {
+     attendanceId,
+     employeeId,
+     workDate,
+     clockInTime,
+     clockOutTime,
+     clockInType,
+     clockOutType,
+     workLocationCode,
+     remarkText
+   } = req.body;
+ 
+   if (!employeeId || !workDate) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDと勤務日が必要です。'
+     });
+   }
+ 
+   try {
+     const now = new Date();
+ 
+     // 既存レコードの確認
+     let currentAttendanceId = attendanceId;
+     
+     if (attendanceId) {
+       // 既存レコードを更新
+       const updateFields = [];
+       const updateValues = [];
+ 
+       if (clockInTime !== undefined) {
+         updateFields.push('CLOCK_IN_TIME = ?');
+         updateValues.push(clockInTime);
+       }
+       if (clockOutTime !== undefined) {
+         updateFields.push('CLOCK_OUT_TIME = ?');
+         updateValues.push(clockOutTime);
+       }
+       if (clockInType !== undefined) {
+         updateFields.push('CLOCK_IN_TYPE = ?');
+         updateValues.push(clockInType);
+       }
+       if (clockOutType !== undefined) {
+         updateFields.push('CLOCK_OUT_TYPE = ?');
+         updateValues.push(clockOutType);
+       }
+       if (workLocationCode !== undefined) {
+         updateFields.push('WORK_LOCATION_CODE = ?');
+         updateValues.push(workLocationCode);
+       }
+       if (remarkText !== undefined) {
+         updateFields.push('REMARK_TEXT = ?');
+         updateValues.push(remarkText);
+       }
+ 
+       updateFields.push('UPDATED_AT = ?');
+       updateValues.push(now);
+       updateValues.push(attendanceId);
+ 
+       await db.execute(
+         &#96;UPDATE ATTENDANCE_RECORD SET ${updateFields.join(', ')} WHERE ATTENDANCE_ID = ?&#96;,
+         updateValues
+       );
+     } else {
+       // 新規レコードを作成
+       const [result] = await db.execute(
+         &#96;INSERT INTO ATTENDANCE_RECORD 
+          (EMPLOYEE_ID, WORK_DATE, CLOCK_IN_TIME, CLOCK_OUT_TIME, CLOCK_IN_TYPE, CLOCK_OUT_TYPE, WORK_LOCATION_CODE, REMARK_TEXT, CREATED_AT, UPDATED_AT)
+          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&#96;,
+         [employeeId, workDate, clockInTime, clockOutTime, clockInType || 'MANUAL', clockOutType || 'MANUAL', workLocationCode, remarkText, now, now]
+       );
+       currentAttendanceId = result.insertId;
+     }
+ 
+     // 実労働時間を計算
+     if (clockInTime &amp;&amp; clockOutTime) {
+       const clockIn = new Date(clockInTime);
+       const clockOut = new Date(clockOutTime);
+       const totalMinutes = (clockOut - clockIn) / 1000 / 60;
+ 
+       // 休憩時間の合計を取得
+       const [breakRows] = await db.execute(
+         &#96;SELECT SUM(BREAK_DURATION_MINUTES) as totalBreak FROM BREAK_TIME WHERE ATTENDANCE_ID = ?&#96;,
+         [currentAttendanceId]
+       );
+       const breakMinutes = breakRows[0]?.totalBreak || 0;
+ 
+       const actualWorkHours = (totalMinutes - breakMinutes) / 60;
+ 
+       await db.execute(
+         &#96;UPDATE ATTENDANCE_RECORD SET ACTUAL_WORK_HOURS = ?, UPDATED_AT = ? WHERE ATTENDANCE_ID = ?&#96;,
+         [actualWorkHours, now, currentAttendanceId]
+       );
+     }
+ 
+     // 更新後のデータを取得
+     const [updatedRows] = await db.execute(
+       &#96;SELECT * FROM ATTENDANCE_RECORD WHERE ATTENDANCE_ID = ?&#96;,
+       [currentAttendanceId]
+     );
+ 
+     res.json({
+       success: true,
+       message: '勤怠記録を更新しました。',
+       attendance: updatedRows[0]
+     });
+   } catch (error) {
+     console.error('勤怠記録更新エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '勤怠記録の更新に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 休憩時間登録・更新API
+  * POST /api/attendance/break-time
+  */
+ router.post('/break-time', async (req, res) =&gt; {
+   const { attendanceId, breakSeq, breakStartTime, breakEndTime, breakType } = req.body;
+ 
+   if (!attendanceId || !breakSeq || !breakStartTime) {
+     return res.status(400).json({
+       success: false,
+       message: '勤怠ID、休憩番号、開始時刻が必要です。'
+     });
+   }
+ 
+   try {
+     const now = new Date();
+     
+     // 休憩時間を計算
+     let breakDuration = null;
+     if (breakStartTime &amp;&amp; breakEndTime) {
+       const start = new Date(breakStartTime);
+       const end = new Date(breakEndTime);
+       breakDuration = Math.floor((end - start) / 1000 / 60);
+     }
+ 
+     // 既存レコードの確認
+     const [existingRows] = await db.execute(
+       &#96;SELECT BREAK_ID FROM BREAK_TIME WHERE ATTENDANCE_ID = ? AND BREAK_SEQ = ?&#96;,
+       [attendanceId, breakSeq]
+     );
+ 
+     if (existingRows.length &gt; 0) {
+       // 更新
+       await db.execute(
+         &#96;UPDATE BREAK_TIME 
+          SET BREAK_START_TIME = ?, BREAK_END_TIME = ?, BREAK_DURATION_MINUTES = ?, BREAK_TYPE = ?, UPDATED_AT = ?
+          WHERE BREAK_ID = ?&#96;,
+         [breakStartTime, breakEndTime, breakDuration, breakType || 'REGULAR', now, existingRows[0].BREAK_ID]
+       );
+     } else {
+       // 新規登録
+       await db.execute(
+         &#96;INSERT INTO BREAK_TIME 
+          (ATTENDANCE_ID, BREAK_SEQ, BREAK_START_TIME, BREAK_END_TIME, BREAK_DURATION_MINUTES, BREAK_TYPE, CREATED_AT, UPDATED_AT)
+          VALUES (?, ?, ?, ?, ?, ?, ?, ?)&#96;,
+         [attendanceId, breakSeq, breakStartTime, breakEndTime, breakDuration, breakType || 'REGULAR', now, now]
+       );
+     }
+ 
+     res.json({
+       success: true,
+       message: '休憩時間を登録しました。'
+     });
+   } catch (error) {
+     console.error('休憩時間登録エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '休憩時間の登録に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 公用外出登録・更新API
+  * POST /api/attendance/official-outing
+  */
+ router.post('/official-outing', async (req, res) =&gt; {
+   const { attendanceId, outingSeq, outingStartTime, outingEndTime, outingPurpose } = req.body;
+ 
+   if (!attendanceId || !outingSeq || !outingStartTime) {
+     return res.status(400).json({
+       success: false,
+       message: '勤怠ID、外出番号、開始時刻が必要です。'
+     });
+   }
+ 
+   try {
+     const now = new Date();
+     
+     // 外出時間を計算
+     let outingDuration = null;
+     if (outingStartTime &amp;&amp; outingEndTime) {
+       const start = new Date(outingStartTime);
+       const end = new Date(outingEndTime);
+       outingDuration = Math.floor((end - start) / 1000 / 60);
+     }
+ 
+     // 既存レコードの確認
+     const [existingRows] = await db.execute(
+       &#96;SELECT OUTING_ID FROM OFFICIAL_OUTING WHERE ATTENDANCE_ID = ? AND OUTING_SEQ = ?&#96;,
+       [attendanceId, outingSeq]
+     );
+ 
+     if (existingRows.length &gt; 0) {
+       // 更新
+       await db.execute(
+         &#96;UPDATE OFFICIAL_OUTING 
+          SET OUTING_START_TIME = ?, OUTING_END_TIME = ?, OUTING_DURATION_MINUTES = ?, OUTING_PURPOSE = ?, UPDATED_AT = ?
+          WHERE OUTING_ID = ?&#96;,
+         [outingStartTime, outingEndTime, outingDuration, outingPurpose, now, existingRows[0].OUTING_ID]
+       );
+     } else {
+       // 新規登録
+       await db.execute(
+         &#96;INSERT INTO OFFICIAL_OUTING 
+          (ATTENDANCE_ID, OUTING_SEQ, OUTING_START_TIME, OUTING_END_TIME, OUTING_DURATION_MINUTES, OUTING_PURPOSE, CREATED_AT, UPDATED_AT)
+          VALUES (?, ?, ?, ?, ?, ?, ?, ?)&#96;,
+         [attendanceId, outingSeq, outingStartTime, outingEndTime, outingDuration, outingPurpose, now, now]
+       );
+     }
+ 
+     res.json({
+       success: true,
+       message: '公用外出を登録しました。'
+     });
+   } catch (error) {
+     console.error('公用外出登録エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '公用外出の登録に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 工数実績取得API
+  * GET /api/attendance/work-hours
+  */
+ router.get('/work-hours', async (req, res) =&gt; {
+   const { employeeId, workDate } = req.query;
+ 
+   if (!employeeId || !workDate) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDと作業日が必要です。'
+     });
+   }
+ 
+   try {
+     const [workHoursRows] = await db.execute(
+       &#96;SELECT 
+         wh.WORK_HOURS_ID,
+         wh.ATTENDANCE_ID,
+         wh.EMPLOYEE_ID,
+         wh.WORK_DATE,
+         wh.JOB_CODE,
+         wh.WORK_CODE,
+         wh.WORK_HOURS_VALUE,
+         wh.WORK_VOLUME,
+         wh.INPUT_TYPE,
+         jm.JOB_NAME
+        FROM WORK_HOURS wh
+        LEFT JOIN JOB_MASTER jm ON wh.JOB_CODE = jm.JOB_CODE
+        WHERE wh.EMPLOYEE_ID = ? AND wh.WORK_DATE = ?
+        ORDER BY wh.WORK_HOURS_ID&#96;,
+       [employeeId, workDate]
+     );
+ 
+     res.json({
+       success: true,
+       workHours: workHoursRows
+     });
+   } catch (error) {
+     console.error('工数実績取得エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '工数実績の取得に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 工数実績登録・更新API
+  * POST /api/attendance/work-hours
+  */
+ router.post('/work-hours', async (req, res) =&gt; {
+   const {
+     workHoursId,
+     attendanceId,
+     employeeId,
+     workDate,
+     jobCode,
+     workCode,
+     workHoursValue,
+     workVolume,
+     inputType
+   } = req.body;
+ 
+   if (!employeeId || !workDate || !jobCode) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員ID、作業日、ジョブコードが必要です。'
+     });
+   }
+ 
+   try {
+     const now = new Date();
+ 
+     if (workHoursId) {
+       // 更新
+       await db.execute(
+         &#96;UPDATE WORK_HOURS 
+          SET JOB_CODE = ?, WORK_CODE = ?, WORK_HOURS_VALUE = ?, WORK_VOLUME = ?, INPUT_TYPE = ?, UPDATED_AT = ?
+          WHERE WORK_HOURS_ID = ?&#96;,
+         [jobCode, workCode, workHoursValue, workVolume, inputType || 'TIME', now, workHoursId]
+       );
+     } else {
+       // 新規登録
+       await db.execute(
+         &#96;INSERT INTO WORK_HOURS 
+          (ATTENDANCE_ID, EMPLOYEE_ID, WORK_DATE, JOB_CODE, WORK_CODE, WORK_HOURS_VALUE, WORK_VOLUME, INPUT_TYPE, CREATED_AT, UPDATED_AT)
+          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)&#96;,
+         [attendanceId, employeeId, workDate, jobCode, workCode, workHoursValue, workVolume, inputType || 'TIME', now, now]
+       );
+     }
+ 
+     res.json({
+       success: true,
+       message: '工数実績を登録しました。'
+     });
+   } catch (error) {
+     console.error('工数実績登録エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '工数実績の登録に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 工数実績削除API
+  * DELETE /api/attendance/work-hours/:workHoursId
+  */
+ router.delete('/work-hours/:workHoursId', async (req, res) =&gt; {
+   const { workHoursId } = req.params;
+ 
+   if (!workHoursId) {
+     return res.status(400).json({
+       success: false,
+       message: '工数実績IDが必要です。'
+     });
+   }
+ 
+   try {
+     await db.execute(
+       &#96;DELETE FROM WORK_HOURS WHERE WORK_HOURS_ID = ?&#96;,
+       [workHoursId]
+     );
+ 
+     res.json({
+       success: true,
+       message: '工数実績を削除しました。'
+     });
+   } catch (error) {
+     console.error('工数実績削除エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '工数実績の削除に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 日次確定申請API
+  * POST /api/attendance/daily-confirmation
+  */
+ router.post('/daily-confirmation', async (req, res) =&gt; {
+   const { employeeId, workDate } = req.body;
+ 
+   if (!employeeId || !workDate) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDと勤務日が必要です。'
+     });
+   }
+ 
+   try {
+     // 勤怠記録を取得
+     const [attendanceRows] = await db.execute(
+       &#96;SELECT 
+         ATTENDANCE_ID,
+         CLOCK_IN_TIME,
+         CLOCK_OUT_TIME,
+         CLOCK_IN_TYPE,
+         CLOCK_OUT_TYPE,
+         WORK_LOCATION_CODE,
+         ACTUAL_WORK_HOURS,
+         REMARK_TEXT
+        FROM ATTENDANCE_RECORD
+        WHERE EMPLOYEE_ID = ? AND WORK_DATE = ?&#96;,
+       [employeeId, workDate]
+     );
+ 
+     if (attendanceRows.length === 0) {
+       return res.status(400).json({
+         success: false,
+         message: '勤怠記録が見つかりません。'
+       });
+     }
+ 
+     const attendance = attendanceRows[0];
+ 
+     // チェック処理
+     const errors = [];
+ 
+     // 出退社時刻チェック
+     if (!attendance.CLOCK_IN_TIME || !attendance.CLOCK_OUT_TIME) {
+       errors.push('出退社時刻が未入力のため、日次確定できません。');
+     }
+ 
+     // 勤務場所チェック
+     if (!attendance.WORK_LOCATION_CODE) {
+       errors.push('勤務場所を選択してください');
+     }
+ 
+     // 手入力の場合の備考チェック
+     if ((attendance.CLOCK_IN_TYPE === 'MANUAL' || attendance.CLOCK_OUT_TYPE === 'MANUAL') &amp;&amp; !attendance.REMARK_TEXT) {
+       errors.push('手入力の場合は備考に理由を入力してください');
+     }
+ 
+     // 工数合計と実労働時間の一致チェック
+     const [workHoursRows] = await db.execute(
+       &#96;SELECT SUM(WORK_HOURS_VALUE) as totalWorkHours FROM WORK_HOURS WHERE ATTENDANCE_ID = ?&#96;,
+       [attendance.ATTENDANCE_ID]
+     );
+     const totalWorkHours = workHoursRows[0]?.totalWorkHours || 0;
+     const actualWorkHours = parseFloat(attendance.ACTUAL_WORK_HOURS) || 0;
+     
+     if (Math.abs(totalWorkHours - actualWorkHours) &gt; 0.01) {
+       errors.push('工数の合計と実労働時間が合いません');
+     }
+ 
+     if (errors.length &gt; 0) {
+       return res.status(400).json({
+         success: false,
+         message: errors.join('\n')
+       });
+     }
+ 
+     // 日次確定を実行
+     const now = new Date();
+     await db.execute(
+       &#96;UPDATE ATTENDANCE_RECORD 
+        SET IS_DAILY_CONFIRMED = TRUE, DAILY_CONFIRMED_AT = ?, APPROVAL_STATUS = 'PENDING', UPDATED_AT = ?
+        WHERE ATTENDANCE_ID = ?&#96;,
+       [now, now, attendance.ATTENDANCE_ID]
+     );
+ 
+     res.json({
+       success: true,
+       message: '日次確定申請が完了しました。'
+     });
+   } catch (error) {
+     console.error('日次確定申請エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '日次確定申請に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 日次確定申請取消API
+  * DELETE /api/attendance/daily-confirmation
+  */
+ router.delete('/daily-confirmation', async (req, res) =&gt; {
+   const { employeeId, workDate } = req.body;
+ 
+   if (!employeeId || !workDate) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDと勤務日が必要です。'
+     });
+   }
+ 
+   try {
+     const now = new Date();
+     await db.execute(
+       &#96;UPDATE ATTENDANCE_RECORD 
+        SET IS_DAILY_CONFIRMED = FALSE, DAILY_CONFIRMED_AT = NULL, APPROVAL_STATUS = 'NOT_SUBMITTED', UPDATED_AT = ?
+        WHERE EMPLOYEE_ID = ? AND WORK_DATE = ?&#96;,
+       [now, employeeId, workDate]
+     );
+ 
+     res.json({
+       success: true,
+       message: '日次確定申請を取り消しました。'
+     });
+   } catch (error) {
+     console.error('日次確定申請取消エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '日次確定申請の取消に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 月次サマリー取得API
+  * GET /api/attendance/monthly-summary
+  */
+ router.get('/monthly-summary', async (req, res) =&gt; {
+   const { employeeId, year, month } = req.query;
+ 
+   if (!employeeId || !year || !month) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員ID、年、月が必要です。'
+     });
+   }
+ 
+   try {
+     const startDate = &#96;${year}-${String(month).padStart(2, '0')}-01&#96;;
+     const endDate = new Date(year, month, 0).toISOString().split('T')[0];
+ 
+     // V_MONTHLY_ATTENDANCEビューから月次サマリーを取得
+     const [summaryRows] = await db.execute(
+       &#96;SELECT * FROM V_MONTHLY_ATTENDANCE 
+        WHERE EMPLOYEE_ID = ? AND WORK_YEAR = ? AND WORK_MONTH = ?&#96;,
+       [employeeId, year, month]
+     );
+ 
+     if (summaryRows.length === 0) {
+       return res.json({
+         success: true,
+         summary: {
+           scheduledWorkDays: 0,
+           actualWorkDays: 0,
+           scheduledWorkHours: '0:00',
+           totalWorkHours: '0:00',
+           overUnderTime: '+0:00',
+           legalHolidayWork: '0:00',
+           withinLegalOvertime: '0:00',
+           overLegalOvertime: '0:00'
+         }
+       });
+     }
+ 
+     const summary = summaryRows[0];
+ 
+     // 時間をHHH:MM形式に変換する関数
+     const formatHours = (hours) =&gt; {
+       const h = Math.floor(hours || 0);
+       const m = Math.round(((hours || 0) - h) * 60);
+       return &#96;${h}:${String(m).padStart(2, '0')}&#96;;
+     };
+ 
+     res.json({
+       success: true,
+       summary: {
+         scheduledWorkDays: summary.SCHEDULED_WORK_DAYS || 0,
+         actualWorkDays: summary.ACTUAL_WORK_DAYS || 0,
+         scheduledWorkHours: formatHours(summary.SCHEDULED_WORK_HOURS),
+         totalWorkHours: formatHours(summary.TOTAL_WORK_HOURS),
+         overUnderTime: &#96;${summary.OVER_UNDER_TIME &gt;= 0 ? '+' : ''}${formatHours(Math.abs(summary.OVER_UNDER_TIME))}&#96;,
+         legalHolidayWork: formatHours(summary.LEGAL_HOLIDAY_WORK_HOURS),
+         withinLegalOvertime: formatHours(summary.WITHIN_LEGAL_OVERTIME_HOURS),
+         overLegalOvertime: formatHours(summary.OVER_LEGAL_OVERTIME_HOURS)
+       }
+     });
+   } catch (error) {
+     console.error('月次サマリー取得エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '月次サマリーの取得に失敗しました。'
+     });
+   }
+ });
+ 
+ /**
+  * 休暇情報取得API
+  * GET /api/attendance/vacation-info
+  */
+ router.get('/vacation-info', async (req, res) =&gt; {
+   const { employeeId } = req.query;
+ 
+   if (!employeeId) {
+     return res.status(400).json({
+       success: false,
+       message: '従業員IDが必要です。'
+     });
+   }
+ 
+   try {
+     // 休暇残日数を取得
+     const [balanceRows] = await db.execute(
+       &#96;SELECT 
+         vbs.VACATION_TYPE_CODE,
+         vbs.VACATION_TYPE_NAME,
+         vbs.GRANTED_DAYS,
+         vbs.USED_DAYS,
+         vbs.REMAINING_DAYS,
+         vbs.EXPIRATION_DATE
+        FROM V_VACATION_BALANCE_SUMMARY vbs
+        WHERE vbs.EMPLOYEE_ID = ?
+        ORDER BY vbs.VACATION_TYPE_CODE&#96;,
+       [employeeId]
+     );
+ 
+     // 休暇取得履歴を取得
+     const [historyRows] = await db.execute(
+       &#96;SELECT 
+         VACATION_ID,
+         VACATION_TYPE_CODE,
+         START_DATE,
+         END_DATE,
+         VACATION_DAYS,
+         REASON,
+         APPROVAL_STATUS
+        FROM VACATION_HISTORY
+        WHERE EMPLOYEE_ID = ?
+        ORDER BY START_DATE DESC
+        LIMIT 20&#96;,
+       [employeeId]
+     );
+ 
+     res.json({
+       success: true,
+       balances: balanceRows,
+       history: historyRows
+     });
+   } catch (error) {
+     console.error('休暇情報取得エラー:', error);
+     res.status(500).json({
+       success: false,
+       message: '休暇情報の取得に失敗しました。'
+     });
+   }
+ });
  
  module.exports = router;
```

</details>

</tool-use>

---

勤務表画面のバックエンドAPIを実装しました。以下の主要なエンドポイントを追加しました:

## 実装したAPI一覧

### 1. **月間勤務表取得API** (`GET /api/attendance/monthly`)
- 指定年月の勤務データを取得
- 日次データ、休憩時間、公用外出、工数実績を含む
- 月次サマリー（所定出勤日数、実出勤日数、総労働時間など）を計算
- 休暇申請データも取得

### 2. **日次勤怠記録取得API** (`GET /api/attendance/daily`)
- 指定日の勤怠記録を取得
- 休憩時間、公用外出を含む

### 3. **勤怠記録更新API** (`PUT /api/attendance/record`)
- 出退勤時刻、勤務場所、備考などを更新
- 新規作成または既存レコード更新に対応
- 実労働時間を自動計算

### 4. **休憩時間登録・更新API** (`POST /api/attendance/break-time`)
- 休憩時間の登録・更新
- 休憩時間を自動計算

### 5. **公用外出登録・更新API** (`POST /api/attendance/official-outing`)
- 公用外出の登録・更新
- 外出時間を自動計算

### 6. **工数実績取得API** (`GET /api/attendance/work-hours`)
- 指定日の工数実績を取得

### 7. **工数実績登録・更新API** (`POST /api/attendance/work-hours`)
- 工数実績の登録・更新

### 8. **工数実績削除API** (`DELETE /api/attendance/work-hours/:workHoursId`)
- 工数実績の削除

### 9. **日次確定申請API** (`POST /api/attendance/daily-confirmation`)
- 日次確定申請を実行
- 以下のチェックを実施:
  - 出退社時刻の入力チェック
  - 勤務場所の選択チェック
  - 手入力時の備考入力チェック
  - 工数合計と実労働時間の一致チェック

### 10. **日次確定申請取消API** (`DELETE /api/attendance/daily-confirmation`)
- 日次確定申請を取り消す

### 11. **月次サマリー取得API** (`GET /api/attendance/monthly-summary`)
- V_MONTHLY_ATTENDANCEビューから月次サマリーを取得

### 12. **休暇情報取得API** (`GET /api/attendance/vacation-info`)
- 休暇残日数と取得履歴を取得

## 主な機能

✅ **月間勤務データの取得と集計**
- 日次データ、休憩時間、公用外出、工数実績を結合
- 月次サマリーの自動計算（所定出勤日数、実出勤日数、総労働時間、過不足時間など）

✅ **勤怠記録の更新**
- 出退勤時刻の手入力対応
- 実労働時間の自動計算

✅ **日次確定申請のバリデーション**
- 出退社時刻、勤務場所、備考、工数合計のチェック

✅ **時間フォーマット変換**
- HHH:MM形式への変換
- 過不足時間の+/-表示

これで勤務表画面のバックエンド実装が完了しました。フロントエンドから呼び出すことで、月間勤務表の表示、勤怠情報の入力・更新、日次確定申請などの機能が利用できます。

---

