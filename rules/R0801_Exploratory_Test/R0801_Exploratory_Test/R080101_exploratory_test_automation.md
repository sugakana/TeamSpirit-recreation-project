# 自動探索テスト 実行プロンプト（Playwright MCP 前提）

私はテスト用コードを事前に用意しません。あなた（Cursor）は **Playwright MCP** を使用して、指定されたウェブアプリケーションを探索的にテストし、バグやセキュリティ上の問題を発見してください。

このドキュメントが参照されたセッションで、ユーザーから探索テスト実施の指示があれば、あなた（エージェント）は以下の「即時実行手順（エージェント用）」に従って、Playwright MCP のツール群を自律的に呼び出し、成果物を所定パスへ保存してください。ユーザーのローカルでの npm 操作や設定変更は不要です。

## 即時実行手順（エージェント用）
- 前提: Playwright MCP が有効化されていること（本書の「必須前提」を満たす）
- `credentials.env` から環境変数を読み込む（パス: `.cursor/rules/R08_ET_Test/R0801_Exploratory_Test/credentials.env`）
  - 必須: `BASE_URL`
  - 任意: `LOGIN_ORG_ID`、`LOGIN_EMAIL`、`LOGIN_PASSWORD`、`ADMIN_USER`、`ADMIN_PASSWORD`
- 直ちに以下を実施する（すべて MCP 経由）
  1. ブラウザを `BASE_URL` で起動し、`browser_snapshot` で初期 DOM とリンクを収集
  2. 認証が必要な UI の場合は、資格情報が存在すればログインフォームへ入力しログインを完了
  3. 常時 `browser_network_requests` を有効化し、API 呼び出しを収集
  4. 画面操作（フォーム入力・遷移・エラー誘発）ごとに `browser_take_screenshot` で証跡を保存
  5. 各ステップで `browser_console_messages` を取得し、ログへ追記
  6. 探索が一巡したら、サイトマップ、API エンドポイント、スクリーンショット、各種ログを規定パスへ出力
- 保存先: `docs/tests/exploratory_results/<実行日時: YYYY-MM-DD_HH-MM-SS>/`
- クリティカル/ハイの発見は都度 `findings-report.md` に追記（再現手順・期待/実際・証跡リンク・修正提案を含む）
- 確認禁止: 実行開始前に「MCPが有効か」「今すぐ実行してよいか」等の事前確認や案内メッセージは出さず、即時に実行を開始する。
- 例外条件: `BASE_URL` が欠落している、到達不能、ログイン不可などの致命的ブロッカー時のみ、原因を簡潔に示して必要最小限の質問を1回だけ行う（ブロッカーでない限りは継続）。

## 使用方法
- プロンプトで具体的なテスト対象URLを指定してください
- 例: 「`https://example.com` の探索テストを実行してください」
- 例: 「`https://example.com/dashboard` から始めてサイト全体を探索してください」

## 重要な制約事項
- **Playwright MCP サーバーでの実行のみ**を想定しています
- **ローカル環境でのnpm操作は一切不要**です
- **設定ファイルの作成は不要**です
- **パッケージのインストールは不要**です

## 必須前提
- **Playwright MCP** が Cursor の MCP 設定で有効化されていること
- **MCP設定内容**:
  ```json
  {
    "mcpServers": {
      "playwrightMCP": {
        "command": "npx",
        "args": [
          "@playwright/mcp@latest"
        ]
      }
    }
  }
  ```
- **絶対禁止**: ローカルでの `npm init`、`npm i`、`npm install`、`yarn install`、`pnpm install` 等のパッケージ操作は **一切行わない**。  
- **絶対禁止**: `package.json` の作成や編集は **一切行わない**。
- **絶対禁止**: `node_modules` ディレクトリの作成や操作は **一切行わない**。
- **絶対禁止**: `playwright.config.ts`、`tsconfig.json` の作成や編集は **一切行わない**。
- テストの生成・実行は **Playwright MCP セッション内** で完結させること。

## 対象
- **テスト対象**: プロンプトで指定されたウェブアプリケーションのURL
  - フロントエンドのUI探索
  - APIの動作検証（ネットワークタブの監視含む）
  - セキュリティ上の脆弱性チェック
  - バグや不具合の探索的発見
- **認証値（実値の所在）**:  
  **`.cursor\rules\R08_ET_Test\R0801_Exploratory_Test\credentials.env`** を参照すること。

### `credentials.env` フォーマット
- 1行1設定の **KEY=VALUE** 形式（UTF-8 / BOMなし）
```
BASE_URL=https://example.com
LOGIN_ORG_ID=ORG001
LOGIN_EMAIL=test@example.com
LOGIN_PASSWORD=password123
ADMIN_USER=admin@example.com
ADMIN_PASSWORD=admin123
```

- 使用ルール：
  - 相対パスの場合は `BASE_URL + パス` で解決。
  - ログインが必要な場合は、事前にログイン処理を実行。
  - ログイン情報は `LOGIN_ORG_ID`（必要な場合）、`LOGIN_EMAIL`、`LOGIN_PASSWORD` 等を使用。
  - 管理者権限が必要な場合は `ADMIN_USER`、`ADMIN_PASSWORD` を使用。

#### 読み取りポリシー（エージェント用）
- 変数は存在すれば使用、未定義ならスキップ（例: `LOGIN_ORG_ID` 不要な画面では入力しない）
- 解析不能な値や必須欠落（`BASE_URL`）は即時ユーザーへ確認

## 実施フロー（必ず MCP 経由）

### ステップ1: 初期探索とサイト構造の把握
1. **サイトマップの作成**
   - 指定されたURLから探索を開始
   - `browser_snapshot` を使用してページ構造を分析
   - リンクを辿り、サイト全体の構造を把握
   - フォーム、ボタン、入力欄などの主要UI要素をリスト化
   - 見つかったページを `docs/tests/exploratory_results/<実行日時>/site-map.json` に保存

2. **ネットワークリクエストの監視**
   - `browser_network_requests` でAPIエンドポイントを把握
   - リクエスト/レスポンスのパターンを分析
   - 認証トークン、セッションIDなどの状態管理方法を記録
   - 見つかったエンドポイントを `docs/tests/exploratory_results/<実行日時>/api-endpoints.json` に保存

### ステップ2: 機能探索とバグ発見
3. **主要機能の探索**
   - フォーム入力: 通常値、境界値、異常値（空、非常に長い文字列、特殊文字等）
   - ボタンクリック: 正常系、連続クリック、並行クリック
   - 画面遷移: ページ間の移動、戻る/進む操作
   - データ表示: リスト表示、ページネーション、検索/フィルタ
   - 各操作後にスクリーンショットを保存

4. **エラー状態の探索**
   - 不正な入力値でのエラーハンドリング確認
   - ネットワークエラー時の挙動確認
   - セッションタイムアウト時の挙動確認
   - 権限不足時の挙動確認
   - 各エラー状態をスクリーンショットで証跡化

### ステップ3: セキュリティ検証
5. **簡易的なセキュリティチェック**
   - **XSS検証**: 入力欄に `<script>alert('XSS')</script>` などのスクリプトを入力
   - **SQLインジェクション検証**: 入力欄に `' OR '1'='1` などの文字列を入力
   - **CSRF検証**: トークン有無の確認、リファラチェックの確認
   - **認証バイパス**: ログイン不要での機密ページアクセス試行
   - **権限昇格**: 通常ユーザーでの管理機能アクセス試行
   - **情報漏洩**: エラーメッセージやコンソール出力からの情報漏洩確認
   - 各検証をスクリーンショットとコンソールログで証跡化

6. **データ検証**
   - `browser_evaluate` で localStorage、sessionStorage、Cookie の内容確認
   - 機密情報の平文保存確認
   - 不適切な権限設定の確認

### ステップ4: 証跡記録
7. **発見事項の記録**
   - 発見した問題を `docs/tests/exploratory_results/<実行日時>/findings-report.md` に記録
   - 重要度（Critical / High / Medium / Low）を付与
   - 再現手順を詳細に記載
   - スクリーンショット、ネットワークログ、コンソールログを添付
   - 可能であれば修正提案を含める

## 実行ポリシー（既定値）
- タイムアウト: 30,000ms（画面操作用）
- 要素待機: 10,000ms
- ページ遷移待機: 30,000ms
- リトライ: ネットワークエラー/タイムアウトを最大 2 回、1000ms 間隔  
- ブラウザ: Chromium（デフォルト）
- ウィンドウサイズ: 1920x1080
- 環境変数置換: `${NAME}` は `credentials.env`（→必要に応じて Cursor 環境変数）で上書き
- **実行環境対応**:
  - 実行環境はWindows PowerShellを想定
  - コマンド実行時は`&&`を使用せず、個別のコマンドとして実行
  - Playwright MCP ツールを直接呼び出すため、コマンド実行は不要

### 出力ポリシー（サイレント実行）
- 実行開始前の前提確認・可否確認・説明メッセージは出さない（サイレント開始）
- 実行中は必要な証跡（スクショ・ログ）に限定して保存。進捗の逐次説明は不要。
- 完了後のみ、成果物パスと重要度 Critical/High の発見概要を簡潔に報告する。

### 実行開始テンプレート（エージェントが内部で実施する手順）
1. `credentials.env` を読み込み、`BASE_URL` を確定
2. ブラウザを起動し `BASE_URL` を開く
3. ログインフォームが存在し、かつ `LOGIN_EMAIL`/`LOGIN_PASSWORD`（必要なら `LOGIN_ORG_ID`）が定義されていれば入力してログインを完了
4. `browser_snapshot` と `browser_network_requests` を有効化し、探索を開始
5. 入力欄には正常/境界/異常値を入力、都度スクリーンショットとログを保存
6. セキュリティ軽量検証を実施（XSS/SQLi/CSRF/認証バイパス/権限昇格/情報漏洩）
7. 結果を規定パスへ出力し、`findings-report.md` を作成

## 保存規約（必須）
- ルート: `docs/tests/exploratory_results/<実行日時>/`（実行日時でフォルダ分割）
  - `<実行日時>`: `YYYY-MM-DD_HH-MM-SS` 形式（例：`2025-01-15_14-30-00`）
- 生成物:
  - `screenshots/` …… スクリーンショット一式
  - `findings-report.md` …… 発見事項レポート（メインファイル）
  - `site-map.json` …… サイト構造マップ
  - `api-endpoints.json` …… 発見されたAPIエンドポイント一覧
  - `browser-console.log` …… ブラウザコンソール出力
  - `network-requests.log` …… ネットワークリクエストログ
- 既存成果物は上書きする（最新の実行結果で更新）

### 保存パス例
- 実行日時: 2025-01-15 14:30:00
- 保存先: `docs/tests/exploratory_results/2025-01-15_14-30-00/`

## 探索方針

### 優先順位
1. **Critical**: 機密情報の漏洩、認証バイパス、SQLインジェクション
2. **High**: CSRF、XSS、権限昇格
3. **Medium**: エラーハンドリング不備、データ整合性問題
4. **Low**: UI/UXの問題、パフォーマンス問題

### 探索範囲
- **深さ優先**: 1つの画面を深く探索してから次の画面へ
- **幅優先**: 複数の画面を浅く探索して全体像を把握
- **ランダム**: 発見したリンクやボタンをランダムに選択
- **戦略的**: セキュリティ上重要な機能（ログイン、会員登録、管理者機能等）を重点的に

### 探索のガイドライン
- 1画面あたり最低3〜5分の探索時間を確保
- 各入力欄には複数のパターン（正常、境界、異常）を試す
- ネットワークタブを常時監視してAPIの呼び出しを記録
- ブラウザコンソールエラーを必ず記録
- 発見した問題は即座にスクリーンショットで証跡化

## レポート形式

### findings-report.md の構成
```markdown
# 探索テスト結果レポート

## 実行概要
- 実行日時: YYYY-MM-DD HH:MM:SS
- テスト対象URL: https://example.com
- 総探索ページ数: XX
- 発見した問題数: Critical: XX, High: XX, Medium: XX, Low: XX
- 実行時間: XXX分

## サイト構造
- 探索したページ一覧
- 主要機能一覧
- 発見されたAPIエンドポイント一覧

## 発見した問題

### [P-001] Critical: SQLインジェクション脆弱性
- **発見場所**: https://example.com/search
- **重要度**: Critical
- **再現手順**:
  1. 検索画面で `' OR '1'='1` を入力
  2. 検索ボタンをクリック
  3. 全てのデータが表示される
- **期待される動作**: 入力値をサニタイズしてエラーを返す
- **実際の動作**: 全データが表示され、機密情報が漏洩
- **スクリーンショット**: [📷](screenshots/P-001-sql-injection.png)
- **修正提案**: プリペアドステートメントの使用、入力値のサニタイズ

### [P-002] High: XSS脆弱性
- **発見場所**: https://example.com/comment
- **重要度**: High
- **再現手順**:
  1. コメント欄に `<script>alert('XSS')</script>` を入力
  2. 投稿ボタンをクリック
  3. コメント一覧でスクリプトが実行される
- **期待される動作**: スクリプトタグをエスケープして表示
- **実際の動作**: スクリプトが実行され、XSS攻撃が可能
- **スクリーンショット**: [📷](screenshots/P-002-xss.png)
- **コンソールログ**: [📄](browser-console.log)
- **修正提案**: HTMLエスケープ処理の実装

### [P-003] Medium: 不正な入力値でのエラーメッセージ不備
- **発見場所**: https://example.com/login
- **重要度**: Medium
- **再現手順**:
  1. ログイン画面で空のメールアドレスを入力
  2. パスワードも空のままログインボタンをクリック
  3. エラーメッセージが表示されない
- **期待される動作**: 「メールアドレスとパスワードを入力してください」というエラーメッセージを表示
- **実際の動作**: 何も表示されず、ユーザーが次に何をすべきか分からない
- **スクリーンショット**: [📷](screenshots/P-003-error-handling.png)
- **修正提案**: 適切なバリデーションメッセージの実装

## ネットワークリクエスト分析
- 発見されたAPIエンドポイント
- 認証トークンの管理方法
- セッション管理の方法
- セキュリティ上の問題があるリクエスト

## 推奨事項
- Critical問題は即座に修正すべき
- High問題は次回リリースまでに修正推奨
- Medium/Low問題は継続的に改善

## コンソールエラー
```
(コンソールエラーの抜粋)
```
```

## 出力（報告メッセージに含めること）
- **探索結果サマリー**:
  - 探索したページ数
  - 発見した問題数（重要度別）
  - 実行時間
- **Critical/High問題の概要**:
  - 問題ID、発見場所、重要度
  - 各問題の簡単な説明
  - スクリーンショットへのリンク
- **エビデンスパス**:
  - `docs/tests/exploratory_results/<実行日時>/` のパス
  - `findings-report.md` のパス

## エラー時の対応（エージェント向け）
- `BASE_URL` 未設定、または到達不可: 理由と確認事項（プロキシ/ネットワーク/URL誤り）をユーザーへ即時質問
- ログイン失敗: 入力値・バリデーション・ネットワーク応答（HTTPコード/メッセージ）を記録し、資格情報の再確認を依頼
- 書き込み権限なし: 保存先パスと権限の確認を依頼し、可能なら代替パスを提示

## 注意事項
- Playwright MCP ツールを直接呼び出すため、テストスクリプトファイルは作成しない
- 各探索ステップの実行結果は、MCP ツールの戻り値から取得する
- スクリーンショットは `browser_take_screenshot` で保存し、ファイル名を記録する
- ブラウザコンソールは `browser_console_messages` で取得する
- ネットワークリクエストは `browser_network_requests` で取得する
- エラー発生時は、できるだけ詳細な情報を記録する（スクリーンショット、コンソールログ、ネットワークログ、ページHTML等）
- 探索実行前に、必ず `browser_snapshot` でページ構造を確認し、正しい `ref` を使用する
- **セキュリティテストの注意**:
  - 負荷のかからない範囲で簡易的な攻撃のみを試す
  - システムをクラッシュさせるような攻撃は行わない
  - テスト対象が本番環境の場合は、特に注意して軽量な検証のみ実施
  - ダミーデータの作成・削除が必要な場合は、必ず実行後にクリーンアップする

