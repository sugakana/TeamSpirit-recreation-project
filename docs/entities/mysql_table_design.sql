-- ====================================================================
-- TeamSpirit勤怠管理システム
-- MySQLテーブル設計スクリプト
-- 作成日: 2025-11-27
-- 
-- 【重要】このスクリプトは必ず最初から最後まで全体を実行してください。
-- 既存のデータベースは削除されます（DROP DATABASE）。
-- 
-- 日付・時刻フォーマット:
--   日付: YYYY-MM-DD (例: 2025-11-27)
--   時刻: HH:MM (例: 09:00)
--   日時: YYYY-MM-DD HH:MM (例: 2025-11-27 09:00)
-- ====================================================================

-- データベースの作成（既存のデータベースを削除して新規作成）
DROP DATABASE IF EXISTS teamspirit_db;
CREATE DATABASE teamspirit_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE teamspirit_db;

-- ====================================================================
-- マスタテーブル
-- ====================================================================

-- 1. 従業員マスタ (EMPLOYEE)
CREATE TABLE EMPLOYEE (
    EMPLOYEE_ID CHAR(6) NOT NULL COMMENT '従業員ID（社員コード: 数字6桁 例: 000001）',
    EMPLOYEE_NAME VARCHAR(100) NOT NULL COMMENT '従業員名',
    PASSWORD VARCHAR(255) NOT NULL COMMENT 'パスワード（ハッシュ化推奨）',
    EMAIL_ADDRESS VARCHAR(256) NOT NULL COMMENT 'メールアドレス',
    DEPARTMENT VARCHAR(100) COMMENT '部署',
    POSITION VARCHAR(100) COMMENT '役職',
    HIRE_DATE DATE COMMENT '入社日',
    STANDARD_WORK_START_TIME TIME DEFAULT '09:00:00' COMMENT '定時出勤時刻',
    STANDARD_WORK_END_TIME TIME DEFAULT '17:30:00' COMMENT '定時退勤時刻',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (EMPLOYEE_ID),
    CONSTRAINT CK_EMPLOYEE_ID_FORMAT CHECK (EMPLOYEE_ID REGEXP '^[0-9]{6}$'),
    UNIQUE KEY UK_EMAIL (EMAIL_ADDRESS(191))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='従業員マスタ';

-- 2. 勤務場所マスタ (WORK_LOCATION)
CREATE TABLE WORK_LOCATION (
    LOCATION_CODE VARCHAR(20) NOT NULL COMMENT '勤務場所コード',
    LOCATION_NAME VARCHAR(50) NOT NULL COMMENT '勤務場所名',
    DISPLAY_ORDER INT NOT NULL COMMENT '表示順',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (LOCATION_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='勤務場所マスタ';

-- 3. ジョブマスタ (JOB_MASTER)
CREATE TABLE JOB_MASTER (
    JOB_CODE VARCHAR(50) NOT NULL COMMENT 'ジョブコード',
    JOB_NAME VARCHAR(200) NOT NULL COMMENT 'ジョブ名',
    JOB_CATEGORY VARCHAR(50) COMMENT 'ジョブカテゴリ',
    PROJECT_CODE VARCHAR(50) COMMENT 'プロジェクトコード',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    START_DATE DATE COMMENT '開始日',
    END_DATE DATE COMMENT '終了日',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (JOB_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='ジョブマスタ';

-- 4. 休暇種別マスタ (VACATION_TYPE)
CREATE TABLE VACATION_TYPE (
    VACATION_TYPE_CODE VARCHAR(20) NOT NULL COMMENT '休暇種別コード',
    VACATION_TYPE_NAME VARCHAR(50) NOT NULL COMMENT '休暇種別名',
    VACATION_CATEGORY VARCHAR(20) NOT NULL COMMENT '休暇カテゴリ(有給/特別/etc)',
    IS_PAID BOOLEAN DEFAULT FALSE COMMENT '有給フラグ',
    ANNUAL_GRANT_DAYS DECIMAL(4,1) DEFAULT 0 COMMENT '年間付与日数',
    DISPLAY_ORDER INT NOT NULL COMMENT '表示順',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (VACATION_TYPE_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='休暇種別マスタ';

-- 5. お知らせマスタ (NOTIFICATION)
CREATE TABLE NOTIFICATION (
    NOTIFICATION_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT 'お知らせID',
    NOTIFICATION_TYPE VARCHAR(20) NOT NULL COMMENT 'お知らせ種別(ユーザー/グループ)',
    TARGET_TYPE VARCHAR(20) NOT NULL COMMENT '対象種別(全体/部署/個人)',
    TARGET_ID VARCHAR(50) COMMENT '対象ID',
    TITLE VARCHAR(200) NOT NULL COMMENT 'タイトル',
    CONTENT TEXT NOT NULL COMMENT '内容',
    DISPLAY_START_DATE DATETIME NOT NULL COMMENT '表示開始日時',
    DISPLAY_END_DATE DATETIME COMMENT '表示終了日時',
    IS_IMPORTANT BOOLEAN DEFAULT FALSE COMMENT '重要フラグ',
    IS_ACTIVE BOOLEAN DEFAULT TRUE COMMENT '有効フラグ',
    CREATED_BY VARCHAR(50) COMMENT '作成者',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (NOTIFICATION_ID),
    INDEX IDX_TARGET (TARGET_TYPE, TARGET_ID),
    INDEX IDX_DISPLAY_DATE (DISPLAY_START_DATE, DISPLAY_END_DATE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='お知らせマスタ';

-- ====================================================================
-- トランザクションテーブル
-- ====================================================================

-- 6. 勤怠記録 (ATTENDANCE_RECORD)
-- 日次の出退勤時刻、勤務時間、承認状態などを記録するメインテーブル
-- 1人の従業員は1日1レコードのみ（EMPLOYEE_ID + WORK_DATEでユニーク）
--
-- 【フレックスタイム制の適用】
-- - 標準勤務時間: 9:00-17:30（1日7.5時間）
-- - 最小勤務時間: 3時間45分/日
-- - 遅刻・早退の概念は適用しない
-- - 時間外労働・休日労働は事前に所属長の許可が必要
--
-- 【残業時間の区分】
-- - WITHIN_LEGAL_OVERTIME_HOURS: 7.5h超〜8h以内の残業
-- - OVER_LEGAL_OVERTIME_HOURS: 8h超の残業（即座に法定時間外残業として扱う）
-- - 割増賃金: 所定の割増率に基づき算定
CREATE TABLE ATTENDANCE_RECORD (
    ATTENDANCE_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '勤怠ID: 主キー。勤怠記録を一意に識別するID（自動採番）',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID: 外部キー。どの従業員の勤怠記録か。EMPLOYEEテーブルを参照',
    WORK_DATE DATE NOT NULL COMMENT '勤務日: どの日の勤怠記録か。形式YYYY-MM-DD。従業員IDと勤務日の組み合わせでユニーク',
    CLOCK_IN_TIME DATETIME COMMENT '出勤時刻: WEBタイムレコーダーで打刻した時刻、または手入力した時刻。形式YYYY-MM-DD HH:MM:SS',
    CLOCK_OUT_TIME DATETIME COMMENT '退勤時刻: WEBタイムレコーダーで打刻した時刻、または手入力した時刻。形式YYYY-MM-DD HH:MM:SS',
    CLOCK_IN_TYPE VARCHAR(20) COMMENT '出勤打刻種別: STAMP=打刻、MANUAL=手入力、SCHEDULED=定時出勤。画面で背景色を変えるために使用',
    CLOCK_OUT_TYPE VARCHAR(20) COMMENT '退勤打刻種別: STAMP=打刻、MANUAL=手入力、SCHEDULED=定時退勤。画面で背景色を変えるために使用',
    ORIGINAL_CLOCK_IN_TIME DATETIME COMMENT '出勤打刻時刻: 打刻機による元の時刻。手入力で変更されても保持される。形式YYYY-MM-DD HH:MM:SS',
    ORIGINAL_CLOCK_OUT_TIME DATETIME COMMENT '退勤打刻時刻: 打刻機による元の時刻。手入力で変更されても保持される。形式YYYY-MM-DD HH:MM:SS',
    WORK_LOCATION_CODE VARCHAR(20) COMMENT '勤務場所コード: 外部キー。COMMUTE=通勤、REMOTE=在宅など。WORK_LOCATIONテーブルを参照。日次確定申請には必須',
    ACTUAL_WORK_HOURS DECIMAL(5,2) COMMENT '実労働時間: 出退勤時刻と休憩時間から自動計算される実際の労働時間（時間単位）。例: 8.50=8時間30分',
    SCHEDULED_WORK_HOURS DECIMAL(5,2) DEFAULT 7.50 COMMENT '所定労働時間: 標準勤務時間（9:00-17:30）から休憩1時間を除いた7.5時間。例: 7.50=7時間30分',
    OVERTIME_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '残業時間: 実労働時間が所定労働時間を超えた分（時間単位）。例: 0.50=30分残業',
    WITHIN_LEGAL_OVERTIME_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '法定時間内残業: 1日8時間以内の残業時間（時間単位）。例: 0.50=30分',
    OVER_LEGAL_OVERTIME_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '法定時間外残業: 1日8時間を超える残業時間（時間単位）。例: 2.00=2時間',
    NIGHT_WORK_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '深夜労働時間: 22時〜5時の労働時間（時間単位）。例: 2.00=2時間',
    LEGAL_HOLIDAY_WORK_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '法定休日労働: 法定休日に働いた時間（時間単位）。例: 8.00=8時間',
    HOLIDAY_WORK_HOURS DECIMAL(5,2) DEFAULT 0 COMMENT '休日労働時間: 休日に働いた時間（時間単位）。例: 8.00=8時間',
    IS_DAILY_CONFIRMED BOOLEAN DEFAULT FALSE COMMENT '日次確定フラグ: TRUE=その日の勤怠を確定申請済み。日次確定ボタンで変更される',
    DAILY_CONFIRMED_AT DATETIME COMMENT '日次確定日時: いつ確定申請したか。形式YYYY-MM-DD HH:MM:SS',
    IS_MONTHLY_CONFIRMED BOOLEAN DEFAULT FALSE COMMENT '月次確定フラグ: TRUE=月次の勤怠を確定申請済み',
    MONTHLY_CONFIRMED_AT DATETIME COMMENT '月次確定日時: いつ月次確定申請したか。形式YYYY-MM-DD HH:MM:SS',
    APPROVAL_STATUS VARCHAR(20) DEFAULT 'NOT_SUBMITTED' COMMENT '承認状態: NOT_SUBMITTED=未申請、PENDING=申請中、APPROVED=承認済、REJECTED=却下',
    REMARK_TEXT TEXT COMMENT '備考内容: 打刻できなかった理由やその他の備考。手入力の場合は必須入力',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時: レコード作成日時（自動設定）',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時: レコード更新日時（自動更新）',
    PRIMARY KEY (ATTENDANCE_ID),
    UNIQUE KEY UK_EMP_DATE (EMPLOYEE_ID, WORK_DATE),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    FOREIGN KEY (WORK_LOCATION_CODE) REFERENCES WORK_LOCATION(LOCATION_CODE),
    INDEX IDX_WORK_DATE (WORK_DATE),
    INDEX IDX_APPROVAL (APPROVAL_STATUS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='勤怠記録';

-- 7. 休憩時間 (BREAK_TIME)
CREATE TABLE BREAK_TIME (
    BREAK_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '休憩ID',
    ATTENDANCE_ID BIGINT NOT NULL COMMENT '勤怠ID',
    BREAK_SEQ INT NOT NULL COMMENT '休憩順序(1,2,3)',
    BREAK_START_TIME DATETIME NOT NULL COMMENT '休憩開始時刻',
    BREAK_END_TIME DATETIME COMMENT '休憩終了時刻',
    BREAK_DURATION_MINUTES INT COMMENT '休憩時間(分)',
    BREAK_TYPE VARCHAR(20) DEFAULT 'REGULAR' COMMENT '休憩種別(通常/中断)',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (BREAK_ID),
    FOREIGN KEY (ATTENDANCE_ID) REFERENCES ATTENDANCE_RECORD(ATTENDANCE_ID) ON DELETE CASCADE,
    INDEX IDX_ATTENDANCE (ATTENDANCE_ID),
    UNIQUE KEY UK_ATT_SEQ (ATTENDANCE_ID, BREAK_SEQ)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='休憩時間';

-- 8. 公用外出 (OFFICIAL_OUTING)
CREATE TABLE OFFICIAL_OUTING (
    OUTING_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '公用外出ID',
    ATTENDANCE_ID BIGINT NOT NULL COMMENT '勤怠ID',
    OUTING_SEQ INT NOT NULL COMMENT '公用外出順序(1,2,3)',
    OUTING_START_TIME DATETIME NOT NULL COMMENT '外出開始時刻',
    OUTING_END_TIME DATETIME COMMENT '外出終了時刻',
    OUTING_DURATION_MINUTES INT COMMENT '外出時間(分)',
    OUTING_PURPOSE VARCHAR(200) COMMENT '外出目的',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (OUTING_ID),
    FOREIGN KEY (ATTENDANCE_ID) REFERENCES ATTENDANCE_RECORD(ATTENDANCE_ID) ON DELETE CASCADE,
    INDEX IDX_ATTENDANCE (ATTENDANCE_ID),
    UNIQUE KEY UK_ATT_SEQ (ATTENDANCE_ID, OUTING_SEQ)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='公用外出';

-- 9. 工数実績 (WORK_HOURS)
CREATE TABLE WORK_HOURS (
    WORK_HOURS_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '工数実績ID',
    ATTENDANCE_ID BIGINT NOT NULL COMMENT '勤怠ID',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID',
    WORK_DATE DATE NOT NULL COMMENT '作業日',
    JOB_CODE VARCHAR(50) NOT NULL COMMENT 'ジョブコード',
    WORK_CODE VARCHAR(50) COMMENT '作業コード',
    WORK_HOURS_VALUE DECIMAL(5,2) NOT NULL COMMENT '工数時間',
    WORK_VOLUME INT COMMENT '作業ボリューム(0-10)',
    INPUT_TYPE VARCHAR(20) DEFAULT 'TIME' COMMENT '入力種別(時間/ボリューム)',
    REMARKS TEXT COMMENT '備考',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (WORK_HOURS_ID),
    FOREIGN KEY (ATTENDANCE_ID) REFERENCES ATTENDANCE_RECORD(ATTENDANCE_ID) ON DELETE CASCADE,
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID),
    FOREIGN KEY (JOB_CODE) REFERENCES JOB_MASTER(JOB_CODE),
    INDEX IDX_EMP_DATE (EMPLOYEE_ID, WORK_DATE),
    INDEX IDX_JOB (JOB_CODE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='工数実績';

-- 10. 休暇残日数 (VACATION_BALANCE)
CREATE TABLE VACATION_BALANCE (
    BALANCE_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '休暇残日数ID',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID',
    VACATION_TYPE_CODE VARCHAR(20) NOT NULL COMMENT '休暇種別コード',
    FISCAL_YEAR INT NOT NULL COMMENT '年度',
    GRANTED_DAYS DECIMAL(4,1) NOT NULL COMMENT '付与日数',
    USED_DAYS DECIMAL(4,1) DEFAULT 0 COMMENT '使用日数',
    REMAINING_DAYS DECIMAL(4,1) NOT NULL COMMENT '残日数',
    GRANT_DATE DATE NOT NULL COMMENT '付与日',
    EXPIRATION_DATE DATE COMMENT '有効期限',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (BALANCE_ID),
    UNIQUE KEY UK_EMP_TYPE_YEAR (EMPLOYEE_ID, VACATION_TYPE_CODE, FISCAL_YEAR),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    FOREIGN KEY (VACATION_TYPE_CODE) REFERENCES VACATION_TYPE(VACATION_TYPE_CODE),
    INDEX IDX_FISCAL_YEAR (FISCAL_YEAR)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='休暇残日数';

-- 11. 月次勤怠 (MONTHLY_ATTENDANCE)
-- 月次の勤怠集計と承認状態を管理するテーブル
CREATE TABLE MONTHLY_ATTENDANCE (
    MONTHLY_ATTENDANCE_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '月次勤怠ID: 主キー。月次勤怠記録を一意に識別するID（自動採番）',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID: 外部キー。どの従業員の月次勤怠か。EMPLOYEEテーブルを参照',
    TARGET_YEAR_MONTH CHAR(7) NOT NULL COMMENT '対象年月: YYYY-MM形式。どの年月の月次勤怠か',
    MONTHLY_APPROVAL_STATUS VARCHAR(20) DEFAULT 'NOT_SUBMITTED' COMMENT '月次承認状態: NOT_SUBMITTED=未確定、PENDING=承認中、APPROVED=承認済み、REJECTED=却下',
    SUBMITTED_AT DATETIME COMMENT '申請日時: いつ月次確定申請したか。形式YYYY-MM-DD HH:MM:SS',
    APPROVED_AT DATETIME COMMENT '承認日時: いつ承認されたか。形式YYYY-MM-DD HH:MM:SS',
    APPROVED_BY VARCHAR(50) COMMENT '承認者ID: 誰が承認したか。EMPLOYEEテーブルの従業員ID',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時: レコード作成日時（自動設定）',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時: レコード更新日時（自動更新）',
    PRIMARY KEY (MONTHLY_ATTENDANCE_ID),
    UNIQUE KEY UK_EMP_MONTH (EMPLOYEE_ID, TARGET_YEAR_MONTH),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    INDEX IDX_TARGET_YEAR_MONTH (TARGET_YEAR_MONTH),
    INDEX IDX_APPROVAL_STATUS (MONTHLY_APPROVAL_STATUS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='月次勤怠';

-- 12. 月次承認履歴 (MONTHLY_APPROVAL_HISTORY)
-- 月次確定の承認履歴を管理するテーブル
CREATE TABLE MONTHLY_APPROVAL_HISTORY (
    HISTORY_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '履歴ID: 主キー。承認履歴を一意に識別するID（自動採番）',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID: 外部キー。どの従業員の承認履歴か。EMPLOYEEテーブルを参照',
    TARGET_YEAR_MONTH CHAR(7) NOT NULL COMMENT '対象年月: YYYY-MM形式。どの年月の承認履歴か',
    SEQ_NO INT NOT NULL COMMENT '順序番号: 同一年月内での履歴の連番（1から始まる）',
    ACTION_DATETIME DATETIME NOT NULL COMMENT 'アクション日時: いつアクションが行われたか。形式YYYY-MM-DD HH:MM:SS',
    ACTION_TYPE VARCHAR(20) NOT NULL COMMENT 'アクション種別: SUBMIT=申請、APPROVE=承認、REJECT=却下、CANCEL=取消',
    ACTOR_ID VARCHAR(50) NOT NULL COMMENT '実行者ID: 誰がアクションを実行したか。EMPLOYEEテーブルの従業員ID',
    COMMENT TEXT COMMENT 'コメント: 承認/却下時のコメント',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時: レコード作成日時（自動設定）',
    PRIMARY KEY (HISTORY_ID),
    UNIQUE KEY UK_EMP_MONTH_SEQ (EMPLOYEE_ID, TARGET_YEAR_MONTH, SEQ_NO),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    INDEX IDX_TARGET_YEAR_MONTH (TARGET_YEAR_MONTH),
    INDEX IDX_ACTION_TYPE (ACTION_TYPE)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='月次承認履歴';

-- 13. 申請履歴 (APPLICATION_HISTORY)
-- 休日出勤申請、残業申請、早朝勤務申請、振替申請などの申請履歴を管理するテーブル
CREATE TABLE APPLICATION_HISTORY (
    APPLICATION_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '申請ID: 主キー。申請履歴を一意に識別するID（自動採番）',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID: 外部キー。どの従業員の申請か。EMPLOYEEテーブルを参照',
    APPLICATION_TYPE VARCHAR(20) NOT NULL COMMENT '申請種別: HOLIDAY_WORK=休日出勤申請、OVERTIME=残業申請、EARLY_WORK=早朝勤務申請、TRANSFER=振替申請',
    TARGET_START_DATE DATE NOT NULL COMMENT '対象開始日: 申請対象期間の開始日。形式YYYY-MM-DD',
    TARGET_END_DATE DATE NOT NULL COMMENT '対象終了日: 申請対象期間の終了日。形式YYYY-MM-DD',
    OVERTIME_HOURS DECIMAL(5,2) COMMENT '残業時間: 残業申請の場合の残業時間（時間単位）。例: 2.00=2時間',
    REASON TEXT COMMENT '申請理由: 申請の理由や詳細',
    APPROVAL_STATUS VARCHAR(20) DEFAULT 'PENDING' COMMENT '承認状態: PENDING=申請中、APPROVED=承認済、REJECTED=却下',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時: レコード作成日時（自動設定）',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時: レコード更新日時（自動更新）',
    PRIMARY KEY (APPLICATION_ID),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    INDEX IDX_EMP_TYPE (EMPLOYEE_ID, APPLICATION_TYPE),
    INDEX IDX_TARGET_DATE (TARGET_START_DATE, TARGET_END_DATE),
    INDEX IDX_APPROVAL (APPROVAL_STATUS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='申請履歴';

-- 14. 休暇取得履歴 (VACATION_HISTORY)
CREATE TABLE VACATION_HISTORY (
    VACATION_ID BIGINT AUTO_INCREMENT NOT NULL COMMENT '休暇取得ID',
    EMPLOYEE_ID VARCHAR(50) NOT NULL COMMENT '従業員ID',
    VACATION_TYPE_CODE VARCHAR(20) NOT NULL COMMENT '休暇種別コード',
    START_DATE DATE NOT NULL COMMENT '開始日',
    END_DATE DATE NOT NULL COMMENT '終了日',
    VACATION_DAYS DECIMAL(4,1) NOT NULL COMMENT '取得日数',
    HALF_DAY_TYPE VARCHAR(20) COMMENT '半休種別(午前/午後)',
    REASON TEXT COMMENT '取得理由',
    CONTACT_INFO TEXT COMMENT '連絡先',
    APPROVAL_STATUS VARCHAR(20) DEFAULT 'PENDING' COMMENT '承認状態(申請中/承認済/却下)',
    APPROVED_BY VARCHAR(50) COMMENT '承認者',
    APPROVED_AT DATETIME COMMENT '承認日時',
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '作成日時',
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新日時',
    PRIMARY KEY (VACATION_ID),
    FOREIGN KEY (EMPLOYEE_ID) REFERENCES EMPLOYEE(EMPLOYEE_ID) ON DELETE CASCADE,
    FOREIGN KEY (VACATION_TYPE_CODE) REFERENCES VACATION_TYPE(VACATION_TYPE_CODE),
    INDEX IDX_EMP_DATE (EMPLOYEE_ID, START_DATE, END_DATE),
    INDEX IDX_APPROVAL (APPROVAL_STATUS)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='休暇取得履歴';

-- ====================================================================
-- マスタデータの投入
-- ====================================================================

-- 1. 勤務場所マスタの初期データ
INSERT INTO WORK_LOCATION (LOCATION_CODE, LOCATION_NAME, DISPLAY_ORDER, IS_ACTIVE) VALUES
('COMMUTE', '通勤', 1, TRUE),
('REMOTE', '在宅', 2, TRUE),
('DIRECT', '直行、直帰、直行直帰', 3, TRUE),
('BUSINESS_TRIP', '出張', 4, TRUE);

-- 2. 休暇種別マスタの初期データ
INSERT INTO VACATION_TYPE (VACATION_TYPE_CODE, VACATION_TYPE_NAME, VACATION_CATEGORY, IS_PAID, ANNUAL_GRANT_DAYS, DISPLAY_ORDER, IS_ACTIVE) VALUES
('PAID_LEAVE', '有給休暇', '有給', TRUE, 20.0, 1, TRUE),
('SUMMER_LEAVE', '夏季休暇', '特別', TRUE, 3.0, 2, TRUE),
('SICK_LEAVE', '病気休暇', '特別', TRUE, 5.0, 3, TRUE),
('CONDOLENCE_LEAVE', '忌引休暇', '特別', TRUE, 3.0, 4, TRUE),
('MATERNITY_LEAVE', '産前産後休暇', '特別', TRUE, 0.0, 5, TRUE),
('CHILDCARE_LEAVE', '育児休暇', '特別', TRUE, 0.0, 6, TRUE);

-- 3. ジョブマスタの初期データ（サンプルとして指定された3つの工数）
INSERT INTO JOB_MASTER (JOB_CODE, JOB_NAME, JOB_CATEGORY, PROJECT_CODE, START_DATE, END_DATE, IS_ACTIVE) VALUES
('ZXXXA2506B', 'ZXXXA2506B 人推_育成活動実施25152025-300／00X100 00X収益', 'プロジェクト', '25152025-300', '2025-01-01', '2025-12-31', TRUE),
('ZXXXA2503F', 'ZXXXA2503F S一般開発:自社サービス/ソリューション プロダクト開発2025-611／00X100 00X収益', 'プロジェクト', '2025-611', '2025-01-01', '2025-12-31', TRUE),
('ZZW04', 'ZZW04 間接作業　研修（全社扱い）／00X100 00X収益', '間接作業', '00X100', '2025-01-01', '2025-12-31', TRUE)
ON DUPLICATE KEY UPDATE
  JOB_NAME = VALUES(JOB_NAME),
  JOB_CATEGORY = VALUES(JOB_CATEGORY),
  PROJECT_CODE = VALUES(PROJECT_CODE),
  START_DATE = VALUES(START_DATE),
  END_DATE = VALUES(END_DATE),
  IS_ACTIVE = VALUES(IS_ACTIVE);

-- 4. サンプル従業員データ（ログイン: 社員コード + パスワード）
-- テスト用パスワード: Password@1234（全従業員共通）
INSERT INTO EMPLOYEE (EMPLOYEE_ID, EMPLOYEE_NAME, PASSWORD, EMAIL_ADDRESS, DEPARTMENT, POSITION, HIRE_DATE, STANDARD_WORK_START_TIME, STANDARD_WORK_END_TIME, IS_ACTIVE) VALUES
('000001', '須賀 哉斗', 'Password@1234', 'suga.kanato@example.com', '310 TechE', 'エンジニア', '2020-04-01', '09:00:00', '17:30:00', TRUE),
('000002', '佐藤 花子', 'Password@1234', 'sato.hanako@example.com', '開発部', '主任', '2019-04-01', '09:00:00', '17:30:00', TRUE),
('000003', '鈴木 次郎', 'Password@1234', 'suzuki.jiro@example.com', '営業部', '一般社員', '2021-04-01', '09:00:00', '17:30:00', TRUE);

-- 5. サンプル休暇残日数データ（2025年度）
INSERT INTO VACATION_BALANCE (EMPLOYEE_ID, VACATION_TYPE_CODE, FISCAL_YEAR, GRANTED_DAYS, USED_DAYS, REMAINING_DAYS, GRANT_DATE, EXPIRATION_DATE, CREATED_AT, UPDATED_AT) VALUES
('000001', 'PAID_LEAVE', 2025, 20.0, 5.0, 15.0, '2025-04-01', '2026-03-31', NOW(), NOW()),
('000001', 'SUMMER_LEAVE', 2025, 3.0, 0.0, 3.0, '2025-07-01', '2025-09-30', NOW(), NOW()),
('000002', 'PAID_LEAVE', 2025, 20.0, 8.0, 12.0, '2025-04-01', '2026-03-31', NOW(), NOW()),
('000002', 'SUMMER_LEAVE', 2025, 3.0, 1.0, 2.0, '2025-07-01', '2025-09-30', NOW(), NOW()),
('000003', 'PAID_LEAVE', 2025, 15.0, 3.0, 12.0, '2025-04-01', '2026-03-31', NOW(), NOW()),
('000003', 'SUMMER_LEAVE', 2025, 3.0, 0.0, 3.0, '2025-07-01', '2025-09-30', NOW(), NOW());

-- 6. サンプルお知らせデータ
INSERT INTO NOTIFICATION (NOTIFICATION_TYPE, TARGET_TYPE, TARGET_ID, TITLE, CONTENT, DISPLAY_START_DATE, DISPLAY_END_DATE, IS_IMPORTANT, CREATED_BY) VALUES
('USER', 'ALL', NULL, 'システムメンテナンスのお知らせ', '本日23:00〜翌日2:00の間、システムメンテナンスを実施いたします。', '2025-11-27 09:00:00', '2025-11-28 23:59:59', TRUE, 'SYSTEM'),
('GROUP', 'DEPT', '開発部', '勤怠締め日のリマインド', '今月の勤怠締め日は11月30日です。必ず期日までに確定申請を行ってください。', '2025-11-25 09:00:00', '2025-11-30 23:59:59', FALSE, 'ADMIN'),
-- 12月・1月のお知らせ（4つに分割）
('USER', 'ALL', NULL, '年休取得推奨日のお知らせ（12月・1月）', '12月・1月の年休取得推奨日は、12/12(金)、12/25(木)、1/23(金)です。推奨日を中心にチームで調整し合うなどして、年休を取得しましょう。', '2025-12-01 09:00:00', '2026-01-31 23:59:59', TRUE, 'ADMIN'),
('USER', 'ALL', NULL, '【経企からのお知らせ】KOUKAへのログインについて', '毎日KOUKAへログインして(連続ログインでボーナスKoinゲット)、日々の感謝・称賛の気持ちを伝えましょう！[https://cac.kouka-bc.com/]', '2025-12-01 09:00:00', '2026-01-31 23:59:59', FALSE, 'ADMIN'),
('USER', 'ALL', NULL, '【情シより】FAQと操作マニュアルについて', '不明点はまずはFAQでご確認ください。<C-FAQ (okbiz.jp)>。また、操作マニュアルは「勤務表」、「工数実績」の「？HELP」タブから取得できます。', '2025-12-01 09:00:00', '2026-01-31 23:59:59', FALSE, 'ADMIN'),
('USER', 'ALL', NULL, '工数実績出力レポートについて', '日次承認済みの工数実績をデータとして取得可能となりました。レポートから「07_工数実績出力レポート」を選択してください。詳細な手順はHelpサイトにあります。', '2025-12-01 09:00:00', '2026-01-31 23:59:59', FALSE, 'ADMIN'),
-- 2月のお知らせ（4つに分割）
('USER', 'ALL', NULL, '年休取得推奨日のお知らせ（2月・1月）', '2月・1月の年休取得推奨日は、2/9(月)、2/10(火)、2/20(金)です。推奨日を中心にチームで調整し合うなどして、年休を取得しましょう。', '2026-02-01 09:00:00', '2026-02-28 23:59:59', TRUE, 'ADMIN'),
('USER', 'ALL', NULL, '【経企からのお知らせ】KOUKAへのログインについて', '毎日KOUKAへログインして(連続ログインでボーナスKoinゲット)、日々の感謝・称賛の気持ちを伝えましょう！[https://cac.kouka-bc.com/]', '2026-02-01 09:00:00', '2026-02-28 23:59:59', FALSE, 'ADMIN'),
('USER', 'ALL', NULL, '【情シより】FAQと操作マニュアルについて', '不明点はまずはFAQでご確認ください。<C-FAQ (okbiz.jp)>。また、操作マニュアルは「勤務表」、「工数実績」の「？HELP」タブから取得できます。', '2026-02-01 09:00:00', '2026-02-28 23:59:59', FALSE, 'ADMIN'),
('USER', 'ALL', NULL, '工数実績出力レポートについて', '日次承認済みの工数実績をデータとして取得可能となりました。レポートから「07_工数実績出力レポート」を選択してください。詳細な手順はHelpサイトにあります。', '2026-02-01 09:00:00', '2026-02-28 23:59:59', FALSE, 'ADMIN');

-- 7. サンプル勤怠記録データ（サンプル用の固定日付データ）
INSERT INTO ATTENDANCE_RECORD (
    EMPLOYEE_ID, WORK_DATE, CLOCK_IN_TIME, CLOCK_OUT_TIME, CLOCK_IN_TYPE, CLOCK_OUT_TYPE, 
    ORIGINAL_CLOCK_IN_TIME, ORIGINAL_CLOCK_OUT_TIME,
    WORK_LOCATION_CODE, ACTUAL_WORK_HOURS, SCHEDULED_WORK_HOURS, OVERTIME_HOURS, 
    WITHIN_LEGAL_OVERTIME_HOURS, OVER_LEGAL_OVERTIME_HOURS, LEGAL_HOLIDAY_WORK_HOURS,
    IS_DAILY_CONFIRMED, REMARK_TEXT
) VALUES
-- 000001: 2025-11-25 - 残業1時間（実働8.5時間、所定7.5時間、法定時間内0.5h + 法定時間外0.5h）
('000001', '2025-11-25', '2025-11-25 09:00:00', '2025-11-25 18:30:00', 'STAMP', 'STAMP', '2025-11-25 09:00:00', '2025-11-25 18:30:00', 'COMMUTE', 8.50, 7.50, 1.00, 0.50, 0.50, 0.00, TRUE, NULL),
-- 000001: 2025-11-26 - 残業0.5時間（実働8時間、所定7.5時間、法定時間内0.5h）
('000001', '2025-11-26', '2025-11-26 08:45:00', '2025-11-26 17:45:00', 'STAMP', 'STAMP', '2025-11-26 08:45:00', '2025-11-26 17:45:00', 'REMOTE', 8.00, 7.50, 0.50, 0.50, 0.00, 0.00, TRUE, NULL),
-- 000001: 2025-11-27 - 勤務中（未退勤）
('000001', '2025-11-27', '2025-11-27 09:00:00', NULL, 'STAMP', NULL, '2025-11-27 09:00:00', NULL, 'COMMUTE', NULL, 7.50, 0.00, 0.00, 0.00, 0.00, FALSE, NULL),
-- 000002: 2025-11-25 - 残業1.25時間（実働8.75時間、所定7.5時間、法定時間内0.5h + 法定時間外0.75h）
-- 手入力のため、ORIGINAL_CLOCK_IN_TIMEはNULL（手入力なので元の打刻時刻なし）
('000002', '2025-11-25', '2025-11-25 09:15:00', '2025-11-25 19:00:00', 'MANUAL', 'STAMP', NULL, '2025-11-25 19:00:00', 'COMMUTE', 8.75, 7.50, 1.25, 0.50, 0.75, 0.00, TRUE, '交通機関の遅延により遅刻しました'),
-- 000002: 2025-11-26 - 定時退社（実働7.5時間、所定7.5時間）
('000002', '2025-11-26', '2025-11-26 09:00:00', '2025-11-26 17:30:00', 'SCHEDULED', 'SCHEDULED', '2025-11-26 09:00:00', '2025-11-26 17:30:00', 'REMOTE', 7.50, 7.50, 0.00, 0.00, 0.00, 0.00, TRUE, NULL),
-- 000003: 2025-11-25 - 定時退社（実働7.5時間、所定7.5時間）
('000003', '2025-11-25', '2025-11-25 09:00:00', '2025-11-25 17:30:00', 'STAMP', 'STAMP', '2025-11-25 09:00:00', '2025-11-25 17:30:00', 'COMMUTE', 7.50, 7.50, 0.00, 0.00, 0.00, 0.00, TRUE, NULL),
-- 000001: 2025-12-01 から 2025-12-05 - サンプルデータ（出勤8:50、退勤17:30、通勤）
('000001', '2025-12-01', '2025-12-01 08:50:00', '2025-12-01 17:30:00', 'STAMP', 'STAMP', '2025-12-01 08:50:00', '2025-12-01 17:30:00', 'COMMUTE', 7.67, 7.50, 0.17, 0.17, 0.00, 0.00, FALSE, NULL),
('000001', '2025-12-02', '2025-12-02 08:50:00', '2025-12-02 17:30:00', 'STAMP', 'STAMP', '2025-12-02 08:50:00', '2025-12-02 17:30:00', 'COMMUTE', 7.67, 7.50, 0.17, 0.17, 0.00, 0.00, FALSE, NULL),
('000001', '2025-12-03', '2025-12-03 08:50:00', '2025-12-03 17:30:00', 'STAMP', 'STAMP', '2025-12-03 08:50:00', '2025-12-03 17:30:00', 'COMMUTE', 7.67, 7.50, 0.17, 0.17, 0.00, 0.00, FALSE, NULL),
('000001', '2025-12-04', '2025-12-04 08:50:00', '2025-12-04 17:30:00', 'STAMP', 'STAMP', '2025-12-04 08:50:00', '2025-12-04 17:30:00', 'COMMUTE', 7.67, 7.50, 0.17, 0.17, 0.00, 0.00, FALSE, NULL),
('000001', '2025-12-05', '2025-12-05 08:50:00', '2025-12-05 17:30:00', 'STAMP', 'STAMP', '2025-12-05 08:50:00', '2025-12-05 17:30:00', 'COMMUTE', 7.67, 7.50, 0.17, 0.17, 0.00, 0.00, FALSE, NULL);

-- 8. サンプル休憩時間データ
INSERT INTO BREAK_TIME (ATTENDANCE_ID, BREAK_SEQ, BREAK_START_TIME, BREAK_END_TIME, BREAK_DURATION_MINUTES, BREAK_TYPE) VALUES
(1, 1, '2025-11-25 12:00:00', '2025-11-25 13:00:00', 60, 'REGULAR'),
(2, 1, '2025-11-26 12:00:00', '2025-11-26 13:00:00', 60, 'REGULAR'),
(4, 1, '2025-11-25 12:00:00', '2025-11-25 13:00:00', 60, 'REGULAR'),
(5, 1, '2025-11-26 12:00:00', '2025-11-26 12:30:00', 30, 'REGULAR'),
(6, 1, '2025-11-25 12:00:00', '2025-11-25 13:00:00', 60, 'REGULAR');
-- 2025年12月1日〜5日の休憩時間データ（各日12:00-13:00の1時間休憩）
INSERT INTO BREAK_TIME (ATTENDANCE_ID, BREAK_SEQ, BREAK_START_TIME, BREAK_END_TIME, BREAK_DURATION_MINUTES, BREAK_TYPE)
SELECT ATTENDANCE_ID, 1, CONCAT(WORK_DATE, ' 12:00:00'), CONCAT(WORK_DATE, ' 13:00:00'), 60, 'REGULAR'
FROM ATTENDANCE_RECORD
WHERE EMPLOYEE_ID = '000001' AND WORK_DATE BETWEEN '2025-12-01' AND '2025-12-05';

-- 9. サンプル公用外出データ
INSERT INTO OFFICIAL_OUTING (ATTENDANCE_ID, OUTING_SEQ, OUTING_START_TIME, OUTING_END_TIME, OUTING_DURATION_MINUTES, OUTING_PURPOSE) VALUES
(4, 1, '2025-11-25 15:00:00', '2025-11-25 16:00:00', 60, '顧客訪問');

-- 10. サンプル工数実績データ
INSERT INTO WORK_HOURS (ATTENDANCE_ID, EMPLOYEE_ID, WORK_DATE, JOB_CODE, WORK_CODE, WORK_HOURS_VALUE, INPUT_TYPE) VALUES
(1, '000001', '2025-11-25', 'ZXXXA2506B', 'DEV001', 5.00, 'TIME'),
(1, '000001', '2025-11-25', 'ZZW04', 'TRN001', 3.00, 'TIME'),
(2, '000001', '2025-11-26', 'ZXXXA2503F', 'DEV002', 8.00, 'TIME'),
(4, '000002', '2025-11-25', 'ZXXXA2503F', 'DEV003', 8.00, 'TIME'),
(5, '000002', '2025-11-26', 'ZXXXA2506B', 'DEV004', 7.50, 'TIME'),
(6, '000003', '2025-11-25', 'ZZW04', 'TRN002', 7.50, 'TIME');

-- 11. サンプル休暇取得履歴データ
INSERT INTO VACATION_HISTORY (EMPLOYEE_ID, VACATION_TYPE_CODE, START_DATE, END_DATE, VACATION_DAYS, REASON, APPROVAL_STATUS, APPROVED_BY, APPROVED_AT) VALUES
('000001', 'PAID_LEAVE', '2025-11-20', '2025-11-22', 3.0, '私用', 'APPROVED', 'MGR001', '2025-11-18 10:00:00'),
('000001', 'SUMMER_LEAVE', '2025-08-15', '2025-08-15', 1.0, '夏季休暇', 'APPROVED', 'MGR001', '2025-08-10 14:00:00'),
('000002', 'PAID_LEAVE', '2025-10-10', '2025-10-10', 1.0, '私用', 'APPROVED', 'MGR001', '2025-10-05 11:00:00'),
('000002', 'SUMMER_LEAVE', '2025-08-10', '2025-08-10', 1.0, '夏季休暇', 'APPROVED', 'MGR001', '2025-08-05 09:00:00'),
('000003', 'PAID_LEAVE', '2025-09-05', '2025-09-06', 2.0, '私用', 'APPROVED', 'MGR002', '2025-09-01 16:00:00');

-- 12. サンプル月次勤怠データ
-- 2025年10月: 承認済み
INSERT INTO MONTHLY_ATTENDANCE (EMPLOYEE_ID, TARGET_YEAR_MONTH, MONTHLY_APPROVAL_STATUS, SUBMITTED_AT, APPROVED_AT, APPROVED_BY) VALUES
('000001', '2025-10', 'APPROVED', '2025-10-31 18:00:00', '2025-11-01 10:00:00', '000002'),
('000002', '2025-10', 'APPROVED', '2025-10-31 17:30:00', '2025-11-01 09:30:00', '000001');
-- 2025年11月: 承認中
INSERT INTO MONTHLY_ATTENDANCE (EMPLOYEE_ID, TARGET_YEAR_MONTH, MONTHLY_APPROVAL_STATUS, SUBMITTED_AT) VALUES
('000001', '2025-11', 'PENDING', '2025-11-30 18:00:00'),
('000002', '2025-11', 'PENDING', '2025-11-30 17:45:00');
-- 2025年12月: 未確定（まだ申請していない）
INSERT INTO MONTHLY_ATTENDANCE (EMPLOYEE_ID, TARGET_YEAR_MONTH, MONTHLY_APPROVAL_STATUS) VALUES
('000001', '2025-12', 'NOT_SUBMITTED'),
('000002', '2025-12', 'NOT_SUBMITTED'),
('000003', '2025-12', 'NOT_SUBMITTED');

-- 13. サンプル月次承認履歴データ
-- 2025年10月の承認履歴
INSERT INTO MONTHLY_APPROVAL_HISTORY (EMPLOYEE_ID, TARGET_YEAR_MONTH, SEQ_NO, ACTION_DATETIME, ACTION_TYPE, ACTOR_ID, COMMENT) VALUES
('000001', '2025-10', 1, '2025-10-31 18:00:00', 'SUBMIT', '000001', NULL),
('000001', '2025-10', 2, '2025-11-01 10:00:00', 'APPROVE', '000002', '確認しました'),
('000002', '2025-10', 1, '2025-10-31 17:30:00', 'SUBMIT', '000002', NULL),
('000002', '2025-10', 2, '2025-11-01 09:30:00', 'APPROVE', '000001', NULL);
-- 2025年11月の承認履歴（申請のみ）
INSERT INTO MONTHLY_APPROVAL_HISTORY (EMPLOYEE_ID, TARGET_YEAR_MONTH, SEQ_NO, ACTION_DATETIME, ACTION_TYPE, ACTOR_ID, COMMENT) VALUES
('000001', '2025-11', 1, '2025-11-30 18:00:00', 'SUBMIT', '000001', NULL),
('000002', '2025-11', 1, '2025-11-30 17:45:00', 'SUBMIT', '000002', NULL);

-- ====================================================================
-- インデックスとビューの作成
-- ====================================================================

-- ====================================================================
-- 勤怠記録の月別集計ビュー（月次サマリー）
-- フレックスタイム制に基づく労働時間管理
--
-- 【フレックスタイム制の基本】
-- - 標準勤務時間: 9:00-17:30（標準勤務時間帯）
-- - 1日の標準労働時間: 7.5時間
-- - 最小勤務時間: 3時間45分/日
-- - 清算期間: 1ヶ月単位
-- - 遅刻・早退の概念: フレックスタイム適用社員には適用しない
--
-- 【残業時間の計算】
-- 1. 法定時間内残業: 実作業時間 - 所定労働時間
--    表示範囲: 0:00 <= time <= (所定出勤日数 * 8:00) - 所定労働時間
-- 2. 法定時間外残業: 実作業時間 - 所定出勤日数 * 8:00
--
-- 【過不足時間の扱い】
-- - 計算方法: 前日までの実作業時間 - (前日までの想定出勤日数 * 7:30)
-- - プラス（正の値）: 翌清算期間に繰越可能
-- - マイナス（負の値）: 賃金控除または翌清算期間から控除
-- ====================================================================
CREATE VIEW V_MONTHLY_ATTENDANCE AS
SELECT 
    ar.EMPLOYEE_ID,
    e.EMPLOYEE_NAME,
    DATE_FORMAT(ar.WORK_DATE, '%Y-%m') AS `YEAR_MONTH`,
    -- 所定出勤日数: 月間の営業日数（土日祝を除く日数）を仮に20日と想定
    20 AS SCHEDULED_WORK_DAYS,
    -- 実出勤日数: 実際に出勤した日数（出勤時刻と退勤時刻が両方記録されている日数）
    COUNT(CASE WHEN ar.CLOCK_IN_TIME IS NOT NULL AND ar.CLOCK_OUT_TIME IS NOT NULL THEN 1 END) AS ACTUAL_WORK_DAYS,
    -- 所定労働時間: 所定労働時間の合計（時間単位、標準: 7.5時間/日）
    SUM(ar.SCHEDULED_WORK_HOURS) AS SCHEDULED_WORK_HOURS,
    -- 総労働時間: 実労働時間の合計（時間単位、清算期間内の合計）
    SUM(ar.ACTUAL_WORK_HOURS) AS TOTAL_WORK_HOURS,
    -- 過不足時間: 前日までの実作業時間 - (前日までの想定出勤日数 * 7:30)
    -- 注意: このビューでは簡易計算として実労働時間 - 所定労働時間を表示
    -- 実際の計算は前日までの実作業時間と前日までの想定出勤日数に基づいてバックエンドで実装
    -- プラス: 翌清算期間に繰越可、マイナス: 賃金控除対象
    SUM(ar.ACTUAL_WORK_HOURS) - SUM(ar.SCHEDULED_WORK_HOURS) AS OVER_UNDER_HOURS,
    -- 法定休日労働: 法定休日（週1回の休日）に働いた時間の合計
    SUM(ar.LEGAL_HOLIDAY_WORK_HOURS) AS LEGAL_HOLIDAY_WORK_HOURS,
    -- 法定時間内残業: 実作業時間 - 所定労働時間
    -- 表示範囲: 0:00 <= time <= (所定出勤日数 * 8:00) - 所定労働時間
    -- 注意: 実際の計算はバックエンドで実装（実作業時間 - 所定労働時間）
    SUM(ar.WITHIN_LEGAL_OVERTIME_HOURS) AS WITHIN_LEGAL_OVERTIME_HOURS,
    -- 法定時間外残業: 実作業時間 - 所定出勤日数 * 8:00
    -- 注意: 実際の計算はバックエンドで実装（実作業時間 - 所定出勤日数 * 8:00）
    SUM(ar.OVER_LEGAL_OVERTIME_HOURS) AS OVER_LEGAL_OVERTIME_HOURS,
    -- 従来の項目（互換性のために残す）
    COUNT(ar.ATTENDANCE_ID) AS WORK_DAYS,
    SUM(ar.ACTUAL_WORK_HOURS) AS ACTUAL_WORK_HOURS,
    SUM(ar.OVERTIME_HOURS) AS OVERTIME_HOURS,
    SUM(ar.NIGHT_WORK_HOURS) AS NIGHT_WORK_HOURS,
    SUM(ar.HOLIDAY_WORK_HOURS) AS HOLIDAY_WORK_HOURS,
    SUM(CASE WHEN ar.IS_DAILY_CONFIRMED = TRUE THEN 1 ELSE 0 END) AS CONFIRMED_DAYS,
    SUM(CASE WHEN ar.IS_MONTHLY_CONFIRMED = TRUE THEN 1 ELSE 0 END) AS MONTHLY_CONFIRMED_DAYS
FROM 
    ATTENDANCE_RECORD ar
    INNER JOIN EMPLOYEE e ON ar.EMPLOYEE_ID = e.EMPLOYEE_ID
GROUP BY 
    ar.EMPLOYEE_ID,
    e.EMPLOYEE_NAME,
    DATE_FORMAT(ar.WORK_DATE, '%Y-%m');

-- 工数実績の集計ビュー
CREATE VIEW V_WORK_HOURS_SUMMARY AS
SELECT 
    wh.EMPLOYEE_ID,
    e.EMPLOYEE_NAME,
    wh.JOB_CODE,
    jm.JOB_NAME,
    DATE_FORMAT(wh.WORK_DATE, '%Y-%m') AS `YEAR_MONTH`,
    SUM(wh.WORK_HOURS_VALUE) AS TOTAL_WORK_HOURS,
    COUNT(DISTINCT wh.WORK_DATE) AS WORK_DAYS
FROM 
    WORK_HOURS wh
    INNER JOIN EMPLOYEE e ON wh.EMPLOYEE_ID = e.EMPLOYEE_ID
    INNER JOIN JOB_MASTER jm ON wh.JOB_CODE = jm.JOB_CODE
GROUP BY 
    wh.EMPLOYEE_ID,
    e.EMPLOYEE_NAME,
    wh.JOB_CODE,
    jm.JOB_NAME,
    DATE_FORMAT(wh.WORK_DATE, '%Y-%m');

-- 休暇残日数の集計ビュー
CREATE VIEW V_VACATION_BALANCE_SUMMARY AS
SELECT 
    vb.EMPLOYEE_ID,
    e.EMPLOYEE_NAME,
    vb.VACATION_TYPE_CODE,
    vt.VACATION_TYPE_NAME,
    vb.FISCAL_YEAR,
    vb.GRANTED_DAYS,
    vb.USED_DAYS,
    vb.REMAINING_DAYS,
    vb.EXPIRATION_DATE
FROM 
    VACATION_BALANCE vb
    INNER JOIN EMPLOYEE e ON vb.EMPLOYEE_ID = e.EMPLOYEE_ID
    INNER JOIN VACATION_TYPE vt ON vb.VACATION_TYPE_CODE = vt.VACATION_TYPE_CODE
WHERE 
    vb.FISCAL_YEAR = YEAR(CURDATE());

-- ====================================================================
-- 月次承認履歴ビュー（実行者名を含む）
-- ステータスダイアログで表示する承認履歴を取得するためのビュー
-- ====================================================================
CREATE VIEW V_MONTHLY_APPROVAL_HISTORY AS
SELECT 
    mah.HISTORY_ID,
    mah.EMPLOYEE_ID,
    mah.TARGET_YEAR_MONTH,
    mah.SEQ_NO,
    mah.ACTION_DATETIME,
    mah.ACTION_TYPE,
    CASE mah.ACTION_TYPE
        WHEN 'SUBMIT' THEN '申請'
        WHEN 'APPROVE' THEN '承認'
        WHEN 'REJECT' THEN '却下'
        WHEN 'CANCEL' THEN '取消'
        ELSE mah.ACTION_TYPE
    END AS ACTION_TYPE_DISPLAY,
    mah.ACTOR_ID,
    actor.EMPLOYEE_NAME AS ACTOR_NAME,
    mah.COMMENT,
    mah.CREATED_AT
FROM 
    MONTHLY_APPROVAL_HISTORY mah
    INNER JOIN EMPLOYEE actor ON mah.ACTOR_ID = actor.EMPLOYEE_ID
ORDER BY 
    mah.EMPLOYEE_ID,
    mah.TARGET_YEAR_MONTH,
    mah.SEQ_NO;

-- ====================================================================
-- 動作確認用クエリ
-- ====================================================================

-- 1. 従業員一覧
-- SELECT * FROM EMPLOYEE;

-- 2. 勤務場所一覧
-- SELECT * FROM WORK_LOCATION;

-- 3. ジョブ一覧
-- SELECT * FROM JOB_MASTER;

-- 4. 休暇種別一覧
-- SELECT * FROM VACATION_TYPE;

-- 5. 現在の月の勤怠記録（動的、日付: YYYY-MM-DD、時刻: HH:MM）
-- SELECT 
--     EMPLOYEE_ID,
--     DATE_FORMAT(WORK_DATE, '%Y-%m-%d') AS WORK_DATE,
--     TIME_FORMAT(CLOCK_IN_TIME, '%H:%i') AS CLOCK_IN_TIME,
--     TIME_FORMAT(CLOCK_OUT_TIME, '%H:%i') AS CLOCK_OUT_TIME,
--     ACTUAL_WORK_HOURS
-- FROM ATTENDANCE_RECORD 
-- WHERE WORK_DATE >= DATE_FORMAT(CURDATE(), '%Y-%m-01') 
--   AND WORK_DATE < DATE_FORMAT(DATE_ADD(CURDATE(), INTERVAL 1 MONTH), '%Y-%m-01');

-- 6. 従業員別の月次勤怠集計（現在の月）
-- SELECT * FROM V_MONTHLY_ATTENDANCE WHERE YEAR_MONTH = DATE_FORMAT(CURDATE(), '%Y-%m');

-- 7. 従業員別の工数集計（現在の月）
-- SELECT * FROM V_WORK_HOURS_SUMMARY WHERE YEAR_MONTH = DATE_FORMAT(CURDATE(), '%Y-%m');

-- 8. 指定した年月の勤怠記録を取得する例（例：2025-12）
-- SET @target_year_month = '2025-12';
-- SELECT 
--     EMPLOYEE_ID,
--     DATE_FORMAT(WORK_DATE, '%Y-%m-%d') AS WORK_DATE,
--     TIME_FORMAT(CLOCK_IN_TIME, '%H:%i') AS CLOCK_IN_TIME,
--     TIME_FORMAT(CLOCK_OUT_TIME, '%H:%i') AS CLOCK_OUT_TIME,
--     ACTUAL_WORK_HOURS
-- FROM ATTENDANCE_RECORD 
-- WHERE DATE_FORMAT(WORK_DATE, '%Y-%m') = @target_year_month;

-- 9. 指定した年月の月次サマリーを取得する例（ビューを使用）
-- SET @target_year_month = '2025-12';
-- SELECT * FROM V_MONTHLY_ATTENDANCE WHERE YEAR_MONTH = @target_year_month;

-- 10. 指定した日付の勤怠記録を取得する例（日付フォーマット: YYYY-MM-DD）
-- SET @target_date = '2025-12-01';
-- SELECT 
--     EMPLOYEE_ID,
--     DATE_FORMAT(WORK_DATE, '%Y-%m-%d') AS WORK_DATE,
--     TIME_FORMAT(CLOCK_IN_TIME, '%H:%i') AS CLOCK_IN_TIME,
--     TIME_FORMAT(CLOCK_OUT_TIME, '%H:%i') AS CLOCK_OUT_TIME
-- FROM ATTENDANCE_RECORD 
-- WHERE WORK_DATE = @target_date;

-- 11. ログイン認証（社員コードとパスワードで認証）
-- SET @employee_id = '000001';
-- SET @password = 'Password@1234';
-- SELECT 
--     EMPLOYEE_ID,
--     EMPLOYEE_NAME,
--     DEPARTMENT,
--     POSITION
-- FROM EMPLOYEE
-- WHERE EMPLOYEE_ID = @employee_id
--   AND PASSWORD = @password
--   AND IS_ACTIVE = TRUE;

-- 12. 従業員別の休暇残日数
-- SELECT * FROM V_VACATION_BALANCE_SUMMARY;

-- 13. 月次勤怠の承認状態を確認
-- SET @employee_id = '000001';
-- SET @target_year_month = '2025-11';
-- SELECT 
--     EMPLOYEE_ID,
--     TARGET_YEAR_MONTH,
--     MONTHLY_APPROVAL_STATUS,
--     SUBMITTED_AT,
--     APPROVED_AT
-- FROM MONTHLY_ATTENDANCE
-- WHERE EMPLOYEE_ID = @employee_id
--   AND TARGET_YEAR_MONTH = @target_year_month;

-- 14. 月次承認履歴を取得（ステータスダイアログ用）
-- SET @employee_id = '000001';
-- SET @target_year_month = '2025-10';
-- SELECT 
--     SEQ_NO AS '#',
--     DATE_FORMAT(ACTION_DATETIME, '%Y-%m-%d %H:%i') AS '日時',
--     ACTION_TYPE_DISPLAY AS '状況',
--     ACTOR_NAME AS '実行者',
--     COMMENT AS 'コメント'
-- FROM V_MONTHLY_APPROVAL_HISTORY
-- WHERE EMPLOYEE_ID = @employee_id
--   AND TARGET_YEAR_MONTH = @target_year_month
-- ORDER BY SEQ_NO;

-- ====================================================================
-- サンプルデータ
-- ====================================================================

-- ジョブマスタ
INSERT INTO JOB_MASTER (JOB_CODE, JOB_NAME, JOB_CATEGORY, PROJECT_CODE, IS_ACTIVE, CREATED_AT, UPDATED_AT) VALUES
('JOB001', '開発作業', '開発', 'PROJ001', TRUE, NOW(), NOW()),
('JOB002', '設計作業', '開発', 'PROJ001', TRUE, NOW(), NOW()),
('JOB003', 'レビュー', '品質管理', 'PROJ001', TRUE, NOW(), NOW()),
('JOB004', '会議', '管理業務', NULL, TRUE, NOW(), NOW());

-- 休暇種別マスタ
INSERT INTO VACATION_TYPE (VACATION_TYPE_CODE, VACATION_TYPE_NAME, VACATION_CATEGORY, IS_PAID, ANNUAL_GRANT_DAYS, DISPLAY_ORDER, IS_ACTIVE, CREATED_AT, UPDATED_AT) VALUES
('PAID', '有給休暇', '有給', TRUE, 20, 1, TRUE, NOW(), NOW()),
('SPECIAL', '特別休暇', '特別', TRUE, 5, 2, TRUE, NOW(), NOW()),
('SICK', '病気休暇', '特別', FALSE, 0, 3, TRUE, NOW(), NOW());


-- ====================================================================
-- ORIGINAL_CLOCK_IN_TIMEとORIGINAL_CLOCK_OUT_TIMEの既存データ移行
-- 打刻種別がSTAMPの場合は、CLOCK_IN_TIME/CLOCK_OUT_TIMEをORIGINAL_CLOCK_IN_TIME/ORIGINAL_CLOCK_OUT_TIMEに設定
-- 
-- 【注意】既存のテーブルにカラムを追加する場合のALTER TABLE文（参考用）
-- 注意: カラムが既に存在する場合はエラーになります。その場合は、以下のUPDATE文のみを実行してください。
-- ALTER TABLE ATTENDANCE_RECORD 
-- ADD COLUMN ORIGINAL_CLOCK_IN_TIME DATETIME COMMENT '出勤打刻時刻: 打刻機による元の時刻。手入力で変更されても保持される。形式YYYY-MM-DD HH:MM:SS' AFTER CLOCK_OUT_TYPE,
-- ADD COLUMN ORIGINAL_CLOCK_OUT_TIME DATETIME COMMENT '退勤打刻時刻: 打刻機による元の時刻。手入力で変更されても保持される。形式YYYY-MM-DD HH:MM:SS' AFTER ORIGINAL_CLOCK_IN_TIME;
-- ====================================================================

-- 既存データの移行（CLOCK_IN_TYPEがSTAMPの場合はCLOCK_IN_TIMEをORIGINAL_CLOCK_IN_TIMEに設定）
-- MySQLのsafe update modeに対応するため、WHERE句に主キー（ATTENDANCE_ID）を含める
UPDATE ATTENDANCE_RECORD 
SET ORIGINAL_CLOCK_IN_TIME = CLOCK_IN_TIME 
WHERE ATTENDANCE_ID > 0 
  AND CLOCK_IN_TYPE = 'STAMP' 
  AND (ORIGINAL_CLOCK_IN_TIME IS NULL OR ORIGINAL_CLOCK_IN_TIME = '0000-00-00 00:00:00');

-- 既存データの移行（CLOCK_OUT_TYPEがSTAMPの場合はCLOCK_OUT_TIMEをORIGINAL_CLOCK_OUT_TIMEに設定）
-- MySQLのsafe update modeに対応するため、WHERE句に主キー（ATTENDANCE_ID）を含める
UPDATE ATTENDANCE_RECORD 
SET ORIGINAL_CLOCK_OUT_TIME = CLOCK_OUT_TIME 
WHERE ATTENDANCE_ID > 0 
  AND CLOCK_OUT_TYPE = 'STAMP' 
  AND (ORIGINAL_CLOCK_OUT_TIME IS NULL OR ORIGINAL_CLOCK_OUT_TIME = '0000-00-00 00:00:00');

-- ====================================================================
-- スクリプト終了
-- ====================================================================

