# TeamSpirit勤怠管理システム - ホーム画面 詳細設計書

## 概要

ホーム画面は、ユーザーがログイン後に最初に表示される画面です。本画面では、WEBタイムレコーダーによる出退勤打刻、勤務場所の選択、お知らせの表示を行います。ユーザーは本画面から日々の勤怠を記録し、システムからの重要な通知を確認できます。

## 画面レイアウト

### - ホーム画面（初期表示）

**Figma URL**: https://www.figma.com/design/OVw1Ofj7KB3O5zuj4NzLiu/%E7%84%A1%E9%A1%8C?node-id=2-335&t=1GLEFdQkgSqswbW9-4

**画面構成**:
- ヘッダー部：ロゴ、ナビゲーションメニュー、検索バー
- お知らせセクション：システムからのお知らせ表示
- 打刻セクション：時計表示、勤務場所選択、出退勤ボタン

## 画面項目定義

| No | 項目名 | 種別 | 入力タイプ | ドメイン | 最小桁数 | 最大桁数 | 表示文字数 | 表示形式 | 表示/非表示 | 活性/非活性 | 初期値 | 備考 |
| :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- |
| 1 | ロゴアイコン | 画像 | - | - | - | - | - | - | 表示 | - | - | アプリケーションのロゴを表示 |
| 2 | TimeSpirit | ラベル | - | 文字 | - | - | 11 | - | 表示 | - | TimeSpirit | アプリケーション名 |
| 3 | ホームリンク | リンク | - | 文字 | - | - | 5 | - | 表示 | 活性 | ホーム | ホーム画面へのナビゲーションリンク（アクティブ状態） |
| 4 | 勤務表リンク | リンク | - | 文字 | - | - | 4 | - | 表示 | 活性 | 勤務表 | 勤務表画面へのナビゲーションリンク |
| 5 | 工数実績リンク | リンク | - | 文字 | - | - | 5 | - | 表示 | 活性 | 工数実績 | 工数実績画面へのナビゲーションリンク |
| 6 | レポートリンク | リンク | - | 文字 | - | - | 5 | - | 表示 | 活性 | レポート | レポート画面へのナビゲーションリンク |
| 7 | 検索ボックス | 入力 | テキストボックス | 文字 | 0 | 100 | 100 | - | 表示 | 活性 | - | 検索キーワード入力欄 |
| 8 | メニューアイコン | ボタン | - | - | - | - | - | - | 表示 | 活性 | - | ハンバーガーメニューアイコン |
| 9 | お知らせタイトル | ラベル | - | 文字 | - | - | 10 | - | 表示 | - | お知らせ | お知らせセクションのタイトル |
| 10 | お知らせ1 | 出力 | - | 文字 | - | 500 | 500 | - | 表示 | - | - | NOTIFICATIONテーブルから取得したお知らせ内容 |
| 11 | お知らせ2 | 出力 | - | 文字 | - | 500 | 500 | - | 表示 | - | - | NOTIFICATIONテーブルから取得したお知らせ内容 |
| 12 | お知らせ3 | 出力 | - | 文字 | - | 500 | 500 | - | 表示 | - | - | NOTIFICATIONテーブルから取得したお知らせ内容 |
| 13 | お知らせ4 | 出力 | - | 文字 | - | 500 | 500 | - | 表示 | - | - | NOTIFICATIONテーブルから取得したお知らせ内容 |
| 14 | TimeSpiritタイトル | ラベル | - | 文字 | - | - | 11 | - | 表示 | - | TimeSpirit | 打刻セクションのタイトル |
| 15 | 時計表示エリア | 出力 | - | - | - | - | - | - | 表示 | - | - | 現在時刻を表示するエリア |
| 16 | &nbsp;&nbsp;&nbsp;&nbsp;日付表示 | 出力 | - | 日付 | - | - | 10 | YYYY/MM/DD | 表示 | - | システム日付 | 現在の日付を表示（例：2025/11/25） |
| 17 | &nbsp;&nbsp;&nbsp;&nbsp;時刻表示 | 出力 | - | 時間 | - | - | 5 | HH:MM | 表示 | - | システム時刻 | 現在の時刻を表示（例：11:59）。1秒ごとに更新 |
| 18 | &nbsp;&nbsp;&nbsp;&nbsp;曜日表示 | 出力 | - | 文字 | - | - | 5 | (DAY) | 表示 | - | システム曜日 | 現在の曜日を表示（例：(TUE)） |
| 19 | 勤務場所選択ラベル | ラベル | - | 文字 | - | - | 30 | - | 表示 | - | 勤怠場所を選択して打刻をしてください | 勤務場所選択の説明テキスト |
| 20 | 通勤ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 勤務場所「通勤」を選択。出勤前または退勤前のみ活性 |
| 21 | 在宅ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 勤務場所「在宅」を選択。出勤前または退勤前のみ活性 |
| 22 | 直行・直帰・直行直帰ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 勤務場所「直行」「直帰」「直行直帰」を選択。出勤前または退勤前のみ活性 |
| 23 | 出張ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 勤務場所「出張」を選択。出勤前または退勤前のみ活性 |
| 24 | 出勤ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 出勤打刻を実行。出勤前または中断中のみ活性 |
| 25 | 定時出勤ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 定時出勤（9:00）で打刻を実行。定時前（9:00以前）のみ活性 |
| 26 | 退勤ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 退勤打刻を実行。出勤後のみ活性 |
| 27 | 定時退勤ボタン | ボタン | - | - | - | - | - | - | 表示 | 条件付き活性 | - | 定時退勤（17:30）で打刻を実行。定時後（17:30以降）のみ活性 |

## 入出力項目定義

| No | 項目名 | 種別 | 画面遷移 | ドメイン | 必須 | デフォルト値 | 備考 |
| :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- |
| 1 | 従業員ID | 入力 | ログイン画面 | 文字 | 必須 | - | ログイン認証後に受け取る従業員ID |
| 2 | 従業員名 | 入力 | ログイン画面 | 文字 | 必須 | - | ログイン認証後に受け取る従業員名 |

## その他の項目定義

| No | 項目名 | ドメイン | 正常異常区分 | デフォルト値 | 備考 |
| :----- | :----- | :----- | :----- | :----- | :----- |
| 1 | 選択された勤務場所コード | 文字 | 正常系 | - | WORK_LOCATIONテーブルのLOCATION_CODE。初期状態は未選択 |
| 2 | 当日の勤怠記録ID | 整数 | 正常系 | - | ATTENDANCE_RECORDテーブルのATTENDANCE_ID |
| 3 | 出勤打刻済みフラグ | フラグ | 正常系 | false | 当日に出勤打刻が済んでいるか |
| 4 | 退勤打刻済みフラグ | フラグ | 正常系 | false | 当日に退勤打刻が済んでいるか |
| 5 | 中断中フラグ | フラグ | 正常系 | false | 現在中断中（休憩中）か |
| 6 | お知らせリスト | リスト | 正常系 | [] | NOTIFICATIONテーブルから取得したお知らせのリスト |
| 7 | 休日出勤申請承認済みフラグ | フラグ | 正常系 | false | 当日が土日祝の場合、休日出勤申請が申請中（PENDING）または承認済み（APPROVED）か |
| 8 | エラーメッセージ | 文字 | 異常系 | - | 打刻エラー時のメッセージ |

## イベント処理説明

### 名称：初期表示処理、英名：initializeHomeScreen、処理タイミング：ホーム画面.画面.初期表示

1. **ログイン情報の確認**
   - ログイン画面から受け取った従業員IDと従業員名を取得する。
   - セッションストレージまたはVuexストアに保存されているログイン情報を確認する。

2. **お知らせ情報の取得**
   - 編集仕様 No.1（お知らせ情報編集）に従い、お知らせ情報を編集する。
   - 【編集仕様 No.1（お知らせ情報編集）】

3. **当日の勤怠情報の取得**
   - 編集仕様 No.2（当日勤怠情報編集）に従い、当日の勤怠情報を編集する。
   - 【編集仕様 No.2（当日勤怠情報編集）】

4. **休日出勤申請の確認**
   - 当日が土日祝の場合、編集仕様 No.3（休日出勤申請確認）に従い、休日出勤申請の承認状態を確認する。
   - 【編集仕様 No.3（休日出勤申請確認）】

5. **ボタンの活性/非活性制御**
   - 取得した勤怠情報と休日出勤申請情報に基づき、各ボタンの活性/非活性を設定する。
   - 出勤打刻済みの場合：出勤ボタン、定時出勤ボタンを非活性化
   - 退勤打刻済みの場合：退勤ボタン、定時退勤ボタンを非活性化
   - 定時前（9:00以前）の場合：定時出勤ボタンを活性化
   - 定時後（17:30以降）の場合：定時退勤ボタンを活性化
   - **重要**: 当日が土日祝で、休日出勤申請が申請中（PENDING）または承認済み（APPROVED）でない場合：すべての打刻ボタン（出勤、定時出勤、退勤、定時退勤）を非活性化

6. **時計表示の開始**
   - 1秒ごとに現在時刻を更新する処理を開始する。
   - システム時刻（日付、時刻、曜日）を表示する。

### 名称：勤務場所選択処理、英名：selectWorkLocation、処理タイミング：ホーム画面.勤務場所ボタン.クリック

1. **勤務場所の選択**
   - クリックされたボタンに対応する勤務場所コードを内部変数に保存する。
   - 選択された勤務場所ボタンの背景色を変更し、視覚的にアクティブ状態を示す。
   - 他の勤務場所ボタンの背景色を通常状態に戻す。

2. **選択状態の保持**
   - 選択された勤務場所コードを一時的にコンポーネントのstateに保存する。
   - 業務開始時（出勤打刻時）と業務終了時（退勤打刻時）にそれぞれ勤務場所を選択する必要がある。
   - **重要**: 当日の勤務場所は、業務終了時（退勤打刻時）に選択されていた勤務場所が確定値として保存される。

### 名称：出勤打刻処理、英名：clockIn、処理タイミング：ホーム画面.出勤ボタン.クリック

1. **前提条件**
   - 出勤ボタンが活性化されている（未出勤、または中断中）。
   - 当日が平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）であること。

2. **出勤打刻の登録**
   - テーブル更新仕様 No.1（出勤打刻登録）に従い、出勤時刻を登録する。
   - 【テーブル更新仕様 No.1（出勤打刻登録）】

3. **画面の更新**
   - 出勤ボタンと定時出勤ボタンを非活性化する。
   - 退勤ボタンと定時退勤ボタンを活性化する。
   - 勤務場所選択ボタンを非活性化する。

### 名称：定時出勤打刻処理、英名：clockInScheduled、処理タイミング：ホーム画面.定時出勤ボタン.クリック

1. **前提条件**
   - 定時出勤ボタンが活性化されている（未出勤、かつ現在時刻が9:00以前）。
   - 当日が平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）であること。

2. **定時出勤打刻の登録**
   - テーブル更新仕様 No.2（定時出勤打刻登録）に従い、定時出勤時刻（9:00）を登録する。
   - 【テーブル更新仕様 No.2（定時出勤打刻登録）】

3. **画面の更新**
   - 出勤ボタンと定時出勤ボタンを非活性化する。
   - 退勤ボタンと定時退勤ボタンを活性化する。
   - 勤務場所選択ボタンを非活性化する。

### 名称：退勤打刻処理、英名：clockOut、処理タイミング：ホーム画面.退勤ボタン.クリック

1. **前提条件**
   - 退勤ボタンが活性化されている（出勤済み、かつ未退勤、かつ中断中でない）。

2. **退勤打刻の登録**
   - 中断中フラグを確認し、中断中の場合は休憩時間の終了時刻として記録する。
   - テーブル更新仕様 No.3（退勤打刻登録）に従い、退勤時刻を登録する。
   - 【テーブル更新仕様 No.3（退勤打刻登録）】
   - **重要**: 退勤打刻時に選択されている勤務場所コードが確定値として保存される。

3. **画面の更新**
   - 中断中でない場合：
     - 退勤ボタンと定時退勤ボタンを非活性化する。
     - 出勤ボタンと定時出勤ボタンを非活性化する（1日の勤務が終了）。
   - 中断中の場合：
     - 出勤ボタンを活性化する（再開用）。
     - 退勤ボタンを非活性化する。
     - 中断中フラグをfalseに設定する。

### 名称：定時退勤打刻処理、英名：clockOutScheduled、処理タイミング：ホーム画面.定時退勤ボタン.クリック

1. **前提条件**
   - 定時退勤ボタンが活性化されている（出勤済み、かつ未退勤、かつ現在時刻が17:30以降）。

2. **定時退勤打刻の登録**
   - テーブル更新仕様 No.4（定時退勤打刻登録）に従い、定時退勤時刻（17:30）を登録する。
   - 【テーブル更新仕様 No.4（定時退勤打刻登録）】
   - **重要**: 定時退勤打刻時に選択されている勤務場所コードが確定値として保存される。

3. **画面の更新**
   - 退勤ボタンと定時退勤ボタンを非活性化する。
   - 出勤ボタンと定時出勤ボタンを非活性化する（1日の勤務が終了）。

### 名称：中断打刻処理、英名：breakStart、処理タイミング：ホーム画面.退勤ボタン.クリック（出勤後）

1. **前提条件**
   - 退勤ボタンが活性化されている（出勤済み、かつ未退勤、かつ中断中でない）。
   - ユーザーが業務を一時中断する意図で退勤ボタンを押下。

2. **中断打刻の登録**
   - テーブル更新仕様 No.5（休憩開始登録）に従い、休憩開始時刻を登録する。
   - 【テーブル更新仕様 No.5（休憩開始登録）】
   - **重要**: 打刻した時刻が休憩時間の開始時刻として記録される。

3. **画面の更新**
   - 中断中フラグをtrueに設定する。
   - 退勤ボタンを非活性化する。
   - 出勤ボタンを活性化する（再開用）。

### 名称：再開打刻処理、英名：breakEnd、処理タイミング：ホーム画面.出勤ボタン.クリック（中断後）

1. **前提条件**
   - 出勤ボタンが活性化されている（中断中）。
   - 中断中フラグがtrueであることを確認する。

2. **再開打刻の登録**
   - テーブル更新仕様 No.6（休憩終了登録）に従い、休憩終了時刻を登録する。
   - 【テーブル更新仕様 No.6（休憩終了登録）】
   - **重要**: 打刻した時刻が休憩時間の終了時刻として記録される。
   - **重要**: 退勤打刻から出勤打刻までの時間は、休憩時間として自動的に記録される。

3. **画面の更新**
   - 中断中フラグをfalseに設定する。
   - 出勤ボタンを非活性化する。
   - 退勤ボタンを活性化する。

## 編集仕様

### No.1
- 編集仕様名：お知らせ情報編集
- 関連する取得仕様名：テーブル取得仕様 No.1（お知らせ情報取得）

| 項目名 | 編集内容 | 条件or前提 |
| :--- | :--- | :--- |
| お知らせリスト | テーブル取得仕様 No.1（お知らせ情報取得）で取得したレコードを配列として設定する | - |
| &nbsp;&nbsp;&nbsp;&nbsp;お知らせ1 | お知らせリスト[0].CONTENT | お知らせリストの1件目が存在する場合 |
| &nbsp;&nbsp;&nbsp;&nbsp;お知らせ2 | お知らせリスト[1].CONTENT | お知らせリストの2件目が存在する場合 |
| &nbsp;&nbsp;&nbsp;&nbsp;お知らせ3 | お知らせリスト[2].CONTENT | お知らせリストの3件目が存在する場合 |
| &nbsp;&nbsp;&nbsp;&nbsp;お知らせ4 | お知らせリスト[3].CONTENT | お知らせリストの4件目が存在する場合 |

### No.2
- 編集仕様名：当日勤怠情報編集
- 関連する取得仕様名：テーブル取得仕様 No.2（当日勤怠情報取得）

| 項目名 | 編集内容 | 条件or前提 |
| :--- | :--- | :--- |
| 当日の勤怠記録ID | テーブル取得仕様 No.2（当日勤怠情報取得）.ATTENDANCE_ID | 当日の勤怠記録が存在する場合 |
| 出勤打刻済みフラグ | テーブル取得仕様 No.2（当日勤怠情報取得）.CLOCK_IN_TIME が NULL でない場合は true、NULL の場合は false | - |
| 退勤打刻済みフラグ | テーブル取得仕様 No.2（当日勤怠情報取得）.CLOCK_OUT_TIME が NULL でない場合は true、NULL の場合は false | - |
| 選択された勤務場所コード | テーブル取得仕様 No.2（当日勤怠情報取得）.WORK_LOCATION_CODE | 当日の勤怠記録が存在し、WORK_LOCATION_CODE が NULL でない場合 |

### No.3
- 編集仕様名：休日出勤申請確認
- 関連する取得仕様名：テーブル取得仕様 No.3（休日出勤申請取得）

| 項目名 | 編集内容 | 条件or前提 |
| :--- | :--- | :--- |
| 休日出勤申請承認済みフラグ | 当日が土日祝の場合、テーブル取得仕様 No.3（休日出勤申請取得）で取得した申請のAPPROVAL_STATUSが'PENDING'または'APPROVED'の場合は true、それ以外は false | 当日が土日祝の場合のみ確認 |

## ボタン活性制御仕様

### ボタンの活性/非活性制御ルール

本画面では、ユーザー操作のエラーメッセージは表示せず、ボタンの活性/非活性で制御します。

#### 勤務場所選択ボタン

| ボタン | 活性条件 | 非活性条件 |
| :--- | :--- | :--- |
| 通勤 | 出勤前または退勤前 | 出勤後かつ退勤前 |
| 在宅 | 出勤前または退勤前 | 出勤後かつ退勤前 |
| 直行・直帰・直行直帰 | 出勤前または退勤前 | 出勤後かつ退勤前 |
| 出張 | 出勤前または退勤前 | 出勤後かつ退勤前 |

**備考**: 勤務場所は出勤前または退勤前のみ選択可能。出勤後は勤務場所を変更できない。

#### 打刻ボタン

| ボタン | 活性条件 | 非活性条件 |
| :--- | :--- | :--- |
| 出勤 | 未出勤、または中断中、かつ（平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）） | 出勤済み（中断中を除く）、または（土日祝で休日出勤申請が申請中または承認済みでない） |
| 定時出勤 | 未出勤、かつ現在時刻が9:00以前、かつ（平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）） | 出勤済み、または現在時刻が9:00以降、または（土日祝で休日出勤申請が申請中または承認済みでない） |
| 退勤 | 出勤済み、かつ未退勤、かつ中断中でない、かつ（平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）） | 未出勤、または退勤済み、または中断中、または（土日祝で休日出勤申請が申請中または承認済みでない） |
| 定時退勤 | 出勤済み、かつ未退勤、かつ現在時刻が17:30以降、かつ（平日、または土日祝で休日出勤申請が申請中（PENDING）または承認済み（APPROVED）） | 未出勤、または退勤済み、または現在時刻が17:30以前、または（土日祝で休日出勤申請が申請中または承認済みでない） |

**備考**: 
- 定時出勤ボタンは9:00以降は自動的に非活性化される
- 定時退勤ボタンは17:30以前は自動的に非活性化される
- 中断中は「出勤」ボタンが再開用として活性化され、「退勤」ボタンは非活性化される
- **重要**: 当日が土日祝で、休日出勤申請が申請中（PENDING）または承認済み（APPROVED）でない場合、すべての打刻ボタン（出勤、定時出勤、退勤、定時退勤）は非活性化される
- **重要**: 休日出勤申請が申請中（PENDING）の場合でも、打刻ボタンは活性化され、打刻が可能になる

## テーブル取得仕様

### No.1
- テーブル取得仕様名：お知らせ情報取得
- 対象テーブル：NOTIFICATION
- 取得タイミング：初期表示時

| No | 取得項目 | 項目名（論理名） | 抽出条件 | 並び順 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | NOTIFICATION_ID | お知らせID | IS_ACTIVE = TRUE | NOTIFICATION_ID DESC | 有効なお知らせのみ取得 |
| 2 | TITLE | タイトル | DISPLAY_START_DATE <= システム日時 | - | 表示開始日時が過去または現在 |
| 3 | CONTENT | 内容 | DISPLAY_END_DATE IS NULL OR DISPLAY_END_DATE >= システム日時 | - | 表示終了日時が未設定または未来 |
| 4 | IS_IMPORTANT | 重要フラグ | (TARGET_TYPE = 'ALL') OR (TARGET_TYPE = 'DEPT' AND TARGET_ID = ログインユーザーの部署) OR (TARGET_TYPE = 'EMPLOYEE' AND TARGET_ID = ログインユーザーの従業員ID) | - | 全体通知、部署通知、個人通知のいずれか |

**取得条件の詳細**:
```sql
SELECT NOTIFICATION_ID, TITLE, CONTENT, IS_IMPORTANT
FROM NOTIFICATION
WHERE IS_ACTIVE = TRUE
  AND DISPLAY_START_DATE <= NOW()
  AND (DISPLAY_END_DATE IS NULL OR DISPLAY_END_DATE >= NOW())
  AND (
    (TARGET_TYPE = 'ALL')
    OR (TARGET_TYPE = 'DEPT' AND TARGET_ID = :departmentId)
    OR (TARGET_TYPE = 'EMPLOYEE' AND TARGET_ID = :employeeId)
  )
ORDER BY IS_IMPORTANT DESC, NOTIFICATION_ID DESC
LIMIT 4;
```

### No.2
- テーブル取得仕様名：当日勤怠情報取得
- 対象テーブル：ATTENDANCE_RECORD
- 取得タイミング：初期表示時

| No | 取得項目 | 項目名（論理名） | 抽出条件 | 並び順 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | ATTENDANCE_ID | 勤怠ID | EMPLOYEE_ID = ログインユーザーの従業員ID | - | ログインユーザーの勤怠記録 |
| 2 | CLOCK_IN_TIME | 出勤時刻 | WORK_DATE = システム日付 | - | 当日の勤怠記録 |
| 3 | CLOCK_OUT_TIME | 退勤時刻 | - | - | - |
| 4 | WORK_LOCATION_CODE | 勤務場所コード | - | - | - |

**取得条件の詳細**:
```sql
SELECT ATTENDANCE_ID, CLOCK_IN_TIME, CLOCK_OUT_TIME, WORK_LOCATION_CODE
FROM ATTENDANCE_RECORD
WHERE EMPLOYEE_ID = :employeeId
  AND WORK_DATE = CURDATE()
LIMIT 1;
```

### No.3
- テーブル取得仕様名：休日出勤申請取得
- 対象テーブル：APPLICATION_HISTORY
- 取得タイミング：初期表示時（当日が土日祝の場合のみ）

| No | 取得項目 | 項目名（論理名） | 抽出条件 | 並び順 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | APPLICATION_ID | 申請ID | EMPLOYEE_ID = ログインユーザーの従業員ID | - | ログインユーザーの申請 |
| 2 | APPROVAL_STATUS | 承認状態 | APPLICATION_TYPE = 'HOLIDAY_WORK' | - | 休日出勤申請のみ |
| 3 | TARGET_START_DATE | 対象開始日 | TARGET_START_DATE <= システム日付 | - | 申請期間内 |
| 4 | TARGET_END_DATE | 対象終了日 | TARGET_END_DATE >= システム日付 | - | 申請期間内 |
| 5 | - | - | APPROVAL_STATUS IN ('PENDING', 'APPROVED') | - | 申請中または承認済みのみ |

**取得条件の詳細**:
```sql
SELECT APPLICATION_ID, APPROVAL_STATUS
FROM APPLICATION_HISTORY
WHERE EMPLOYEE_ID = :employeeId
  AND APPLICATION_TYPE = 'HOLIDAY_WORK'
  AND TARGET_START_DATE <= CURDATE()
  AND TARGET_END_DATE >= CURDATE()
  AND APPROVAL_STATUS IN ('PENDING', 'APPROVED')
LIMIT 1;
```

**備考**: 
- 当日が土日祝の場合のみ取得する
- 土日祝の判定は、曜日（0=日曜日、6=土曜日）と祝日ライブラリ（HolidayJp）を使用する
- 申請が存在しない、または申請中（PENDING）・承認済み（APPROVED）でない場合、打刻ボタンは非活性化される
- 申請中（PENDING）の場合でも打刻が可能になる

## テーブル更新仕様

### No.1
- テーブル更新仕様名：出勤打刻登録
- 対象テーブル：ATTENDANCE_RECORD
- 更新タイミング：出勤ボタン押下時

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | EMPLOYEE_ID | 従業員ID | ログインユーザーの従業員ID | 新規レコード作成時 | - |
| 2 | WORK_DATE | 勤務日 | システム日付 | 新規レコード作成時 | - |
| 3 | CLOCK_IN_TIME | 出勤時刻 | システム日時 | - | 現在時刻を設定 |
| 4 | CLOCK_IN_TYPE | 出勤打刻種別 | 'STAMP' | - | 打刻による出勤 |
| 5 | WORK_LOCATION_CODE | 勤務場所コード | 選択された勤務場所コード | - | - |
| 6 | CREATED_AT | 作成日時 | システム日時 | 新規レコード作成時 | - |
| 7 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. 当日の勤怠記録（EMPLOYEE_ID + WORK_DATE）が存在するかチェック
2. 存在しない場合：新規レコードをINSERT
3. 存在する場合：既存レコードをUPDATE（CLOCK_IN_TIME、CLOCK_IN_TYPE、WORK_LOCATION_CODE、UPDATED_ATを更新）

### No.2
- テーブル更新仕様名：定時出勤打刻登録
- 対象テーブル：ATTENDANCE_RECORD
- 更新タイミング：定時出勤ボタン押下時

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | EMPLOYEE_ID | 従業員ID | ログインユーザーの従業員ID | 新規レコード作成時 | - |
| 2 | WORK_DATE | 勤務日 | システム日付 | 新規レコード作成時 | - |
| 3 | CLOCK_IN_TIME | 出勤時刻 | システム日付 + '09:00:00' | - | 定時出勤時刻（9:00）を設定 |
| 4 | CLOCK_IN_TYPE | 出勤打刻種別 | 'SCHEDULED' | - | 定時出勤 |
| 5 | WORK_LOCATION_CODE | 勤務場所コード | 選択された勤務場所コード | - | - |
| 6 | CREATED_AT | 作成日時 | システム日時 | 新規レコード作成時 | - |
| 7 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. 当日の勤怠記録が存在するかチェック
2. 存在しない場合：新規レコードをINSERT
3. 存在する場合：既存レコードをUPDATE

### No.3
- テーブル更新仕様名：退勤打刻登録
- 対象テーブル：ATTENDANCE_RECORD
- 更新タイミング：退勤ボタン押下時

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | CLOCK_OUT_TIME | 退勤時刻 | システム日時 | 中断中でない場合 | 現在時刻を設定 |
| 2 | CLOCK_OUT_TYPE | 退勤打刻種別 | 'STAMP' | 中断中でない場合 | 打刻による退勤 |
| 3 | WORK_LOCATION_CODE | 勤務場所コード | 選択された勤務場所コード | 中断中でない場合 | 確定値として保存 |
| 4 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. 中断中フラグを確認
2. 中断中でない場合：ATTENDANCE_RECORDのCLOCK_OUT_TIME、CLOCK_OUT_TYPE、WORK_LOCATION_CODEを更新
   - **重要**: WORK_LOCATION_CODEは退勤打刻時に選択されている勤務場所コードを確定値として保存する
3. 中断中の場合：テーブル更新仕様 No.6（休憩終了登録）を実行

### No.4
- テーブル更新仕様名：定時退勤打刻登録
- 対象テーブル：ATTENDANCE_RECORD
- 更新タイミング：定時退勤ボタン押下時

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | CLOCK_OUT_TIME | 退勤時刻 | システム日付 + '17:30:00' | - | 定時退勤時刻（17:30）を設定 |
| 2 | CLOCK_OUT_TYPE | 退勤打刻種別 | 'SCHEDULED' | - | 定時退勤 |
| 3 | WORK_LOCATION_CODE | 勤務場所コード | 選択された勤務場所コード | - | 確定値として保存 |
| 4 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. ATTENDANCE_RECORDのCLOCK_OUT_TIME、CLOCK_OUT_TYPE、WORK_LOCATION_CODEを更新
   - **重要**: WORK_LOCATION_CODEは定時退勤打刻時に選択されている勤務場所コードを確定値として保存する

### No.5
- テーブル更新仕様名：休憩開始登録
- 対象テーブル：BREAK_TIME
- 更新タイミング：退勤ボタン押下時（中断時）

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | ATTENDANCE_ID | 勤怠ID | 当日の勤怠記録ID | 新規レコード作成時 | - |
| 2 | BREAK_SEQ | 休憩順序 | 既存の休憩回数 + 1 | 新規レコード作成時 | その日の休憩回数をカウント |
| 3 | BREAK_START_TIME | 休憩開始時刻 | システム日時 | - | 現在時刻を設定 |
| 4 | BREAK_TYPE | 休憩種別 | 'REGULAR' | - | 通常の休憩 |
| 5 | CREATED_AT | 作成日時 | システム日時 | 新規レコード作成時 | - |
| 6 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. 当日の勤怠記録IDを取得
2. BREAK_TIMEテーブルで当日の休憩回数をカウント
3. 新しい休憩レコードをINSERT（BREAK_END_TIMEはNULL）

### No.6
- テーブル更新仕様名：休憩終了登録
- 対象テーブル：BREAK_TIME
- 更新タイミング：出勤ボタン押下時（再開時）

| No | 更新項目 | 項目名（論理名） | 設定値 | 条件 | 備考 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | BREAK_END_TIME | 休憩終了時刻 | システム日時 | - | 現在時刻を設定 |
| 2 | BREAK_DURATION_MINUTES | 休憩時間（分） | (BREAK_END_TIME - BREAK_START_TIME) / 60 | - | 休憩時間を分単位で計算 |
| 3 | UPDATED_AT | 更新日時 | システム日時 | - | - |

**処理ロジック**:
1. 当日の勤怠記録IDを取得
2. BREAK_TIMEテーブルで、BREAK_END_TIMEがNULLの最新レコードを取得
3. BREAK_END_TIMEとBREAK_DURATION_MINUTESを更新

## 業務ルール

1. **勤務場所の選択**
   - 勤務場所は日ごとに「通勤」「在宅」「直行、直帰、直行直帰」「出張」のいずれか1つを選択可能
   - 業務開始時（出勤打刻時）と業務終了時（退勤打刻時）にそれぞれ勤務場所を選択する必要がある
   - **重要**: 当日の勤務場所は、業務終了時（退勤打刻時）に選択されていた勤務場所が確定値として保存される
   - 同日内で通勤と在宅が混在した場合は「通勤」として入力する
     - 通勤で始業し在宅で終業する場合、在宅で始業し通勤で終業する場合、いずれも「通勤」として入力する
   - 「在宅」を選択すると通勤手当は支給されない

2. **定時出勤・定時退勤ボタン**
   - 定時出勤ボタンは9:00より前のみ活性化される。押下すると9:00出勤として記録
   - 定時退勤ボタンは17:30以降のみ活性化される。押下すると17:30退勤として記録

3. **中断・再開機能**
   - 勤務を中断する際は「退勤」ボタンから打刻する。打刻した時刻が休憩時間の開始時刻となる
   - 勤務を再開する際は「出勤」ボタンから打刻する。打刻した時刻が休憩時間の終了時刻となる
   - 退勤打刻から出勤打刻までの時間は休憩時間として自動的に記録される

4. **勤務場所の変更**
   - 勤務場所の変更で発生する中抜け時間は、退勤ボタン→出勤ボタンで打刻する
   - 中抜け時間は休憩時間として自動記録される

5. **打刻の区別**
   - 出退勤の打刻と手入力は背景色で区別される
   - 打刻：CLOCK_IN_TYPE = 'STAMP' または CLOCK_OUT_TYPE = 'STAMP'
   - 手入力：CLOCK_IN_TYPE = 'MANUAL' または CLOCK_OUT_TYPE = 'MANUAL'
   - 定時：CLOCK_IN_TYPE = 'SCHEDULED' または CLOCK_OUT_TYPE = 'SCHEDULED'

6. **休日出勤申請の制約**
   - 土日祝に打刻する場合は、事前に休日出勤申請を行い、申請中（PENDING）または承認済み（APPROVED）である必要がある
   - 休日出勤申請が申請中（PENDING）または承認済み（APPROVED）でない場合、すべての打刻ボタン（出勤、定時出勤、退勤、定時退勤）は非活性化される
   - 土日祝の判定は、曜日（0=日曜日、6=土曜日）と祝日ライブラリ（HolidayJp）を使用する
   - APPLICATION_HISTORYテーブルのAPPLICATION_TYPE='HOLIDAY_WORK'で、APPROVAL_STATUSが'PENDING'または'APPROVED'の申請が存在する場合のみ打刻可能
   - **重要**: 休日出勤申請の承認申請ボタンを押下した時点（申請中（PENDING））から、打刻が可能になる

## データベース設計との対応

### 使用テーブル

1. **EMPLOYEE（従業員マスタ）**
   - ログイン認証後の従業員情報取得に使用
   - EMPLOYEE_ID、EMPLOYEE_NAME、DEPARTMENTを参照

2. **NOTIFICATION（お知らせマスタ）**
   - お知らせ情報の表示に使用
   - TARGET_TYPE（対象種別）、TARGET_ID（対象ID）で絞り込み
   - DISPLAY_START_DATE、DISPLAY_END_DATEで表示期間を制御

3. **ATTENDANCE_RECORD（勤怠記録）**
   - 出退勤打刻の記録に使用
   - EMPLOYEE_ID + WORK_DATEでユニーク制約
   - CLOCK_IN_TIME、CLOCK_OUT_TIME、CLOCK_IN_TYPE、CLOCK_OUT_TYPE、WORK_LOCATION_CODEを更新

4. **WORK_LOCATION（勤務場所マスタ）**
   - 勤務場所の選択肢表示に使用
   - LOCATION_CODE、LOCATION_NAMEを参照

5. **BREAK_TIME（休憩時間）**
   - 中断・再開時の休憩時間記録に使用
   - ATTENDANCE_IDで勤怠記録と紐付け
   - BREAK_SEQで複数の休憩時間帯に対応

6. **APPLICATION_HISTORY（申請履歴）**
   - 休日出勤申請の承認状態確認に使用
   - EMPLOYEE_ID + APPLICATION_TYPE + 対象日で申請を特定
   - APPLICATION_TYPE='HOLIDAY_WORK'で休日出勤申請を識別
   - APPROVAL_STATUS='APPROVED'で承認済みを判定

## 画面遷移

### 遷移元

1. **ログイン画面**
   - ログイン認証成功後、ホーム画面に遷移
   - 遷移パラメータ：従業員ID、従業員名

### 遷移先

1. **勤務表画面**
   - ナビゲーションメニューの「勤務表」リンクをクリック
   - 遷移パラメータ：従業員ID、従業員名

2. **工数実績画面**
   - ナビゲーションメニューの「工数実績」リンクをクリック
   - 遷移パラメータ：従業員ID、従業員名

3. **レポート画面**
   - ナビゲーションメニューの「レポート」リンクをクリック
   - 遷移パラメータ：従業員ID、従業員名

## セキュリティ要件

1. **認証チェック**
   - 画面表示前にログイン状態を確認
   - セッションタイムアウト時はログイン画面にリダイレクト

2. **権限チェック**
   - ログインユーザーの従業員IDと一致する勤怠記録のみ操作可能
   - 他ユーザーの勤怠記録は参照・更新不可

3. **入力値検証**
   - クライアント側とサーバー側の両方で入力値を検証
   - SQLインジェクション対策を実施

## 非機能要件

1. **パフォーマンス**
   - 初期表示は3秒以内に完了
   - 打刻ボタン押下後、1秒以内にレスポンス

2. **可用性**
   - システム稼働率99.9%以上
   - 打刻データのバックアップを1日1回実施

3. **ユーザビリティ**
   - レスポンシブデザインでスマートフォンにも対応
   - ボタンの活性/非活性状態を視覚的に明確に表示

## テスト観点

1. **初期表示**
   - ログイン後、ホーム画面が正常に表示されること
   - お知らせ情報が正しく表示されること
   - 現在時刻が1秒ごとに更新されること

2. **出勤打刻**
   - 勤務場所を選択して出勤ボタンを押すと、出勤時刻が記録されること
   - 出勤打刻後、出勤ボタンと定時出勤ボタンが非活性化されること
   - 勤務場所未選択時、エラーメッセージが表示されること

3. **定時出勤打刻**
   - 9:00より前に定時出勤ボタンを押すと、9:00で出勤時刻が記録されること
   - 9:00以降は定時出勤ボタンが非活性化されること

4. **退勤打刻**
   - 出勤打刻後、退勤ボタンを押すと退勤時刻が記録されること
   - 出勤打刻前に退勤ボタンを押すとエラーメッセージが表示されること

5. **定時退勤打刻**
   - 17:30以降に定時退勤ボタンを押すと、17:30で退勤時刻が記録されること
   - 17:30より前は定時退勤ボタンが非活性化されること

6. **中断・再開**
   - 出勤後、退勤ボタンを押すと休憩開始時刻が記録されること
   - 中断後、出勤ボタンを押すと休憩終了時刻が記録されること
   - 休憩時間が自動計算されること

7. **ボタンの活性/非活性制御**
   - 各状態に応じて、ボタンの活性/非活性が正しく制御されること
   - 視覚的にボタンの状態が分かりやすいこと

8. **休日出勤申請の制約**
   - 土日祝に打刻しようとした場合、休日出勤申請が申請中（PENDING）または承認済み（APPROVED）でない場合は打刻ボタンが非活性化されること
   - 休日出勤申請が申請中（PENDING）または承認済み（APPROVED）の場合のみ、土日祝でも打刻が可能であること
   - 休日出勤申請の承認申請ボタンを押下した時点（申請中（PENDING））から、打刻が可能になること

## 変更履歴

| 日付 | 変更内容 | 変更者 |
|------|----------|--------|
| 2025-12-01 | 初版作成 | AI Assistant |
| 2025-12-XX | 土日祝の打刻制約を追加（休日出勤申請が承認済みの場合のみ打刻可能） | AI Assistant |
| 2025-12-20 | 休日出勤申請の制約を修正。申請中（PENDING）でも打刻が可能になるよう変更。承認申請ボタンを押下した時点から打刻可能になる仕様を追加 | AI Assistant |

